<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPL Player Comparison</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Space+Mono:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0a0e14;
            --bg-darker: #050810;
            --surface: #151920;
            --surface-light: #1d242e;
            --accent-green: #00ff88;
            --accent-red: #ff3366;
            --accent-yellow: #ffcc00;
            --accent-blue: #00ccff;
            --text: #e0e5ed;
            --text-dim: #8b95a5;
            --border: #2a3340;
        }

        body {
            background: var(--bg-dark);
            color: var(--text);
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--bg-darker) 0%, var(--surface) 100%);
            border-bottom: 2px solid var(--accent-green);
            padding: 20px 30px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.1);
        }

        .header h1 {
            font-family: 'Space Mono', monospace;
            font-size: 28px;
            color: var(--accent-green);
            margin-bottom: 5px;
        }

        .header p {
            color: var(--text-dim);
            font-size: 12px;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--surface);
            border: 2px solid var(--border);
            color: var(--text);
            padding: 10px 20px;
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-button:hover {
            border-color: var(--accent-green);
            color: var(--accent-green);
            transform: translateX(-3px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 30px;
        }

        /* Position Selector */
        .position-selector {
            text-align: center;
            margin-bottom: 40px;
        }

        .position-selector h2 {
            font-family: 'Space Mono', monospace;
            font-size: 24px;
            color: var(--accent-green);
            margin-bottom: 30px;
        }

        .position-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        .position-btn {
            background: var(--surface);
            border: 2px solid var(--border);
            padding: 40px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Space Mono', monospace;
            font-size: 16px;
            color: var(--text);
        }

        .position-btn:hover {
            border-color: var(--accent-green);
            background: var(--surface-light);
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 255, 136, 0.2);
        }

        .position-btn.active {
            border-color: var(--accent-green);
            background: var(--surface-light);
        }

        .position-icon {
            font-size: 48px;
            display: block;
            margin-bottom: 10px;
        }

        /* Player Selection */
        .selection-container {
            display: none;
        }

        .selection-container.active {
            display: block;
        }

        .selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .selection-header h2 {
            font-family: 'Space Mono', monospace;
            font-size: 24px;
            color: var(--accent-blue);
        }

        .selection-count {
            font-size: 14px;
            color: var(--accent-yellow);
            font-weight: 700;
        }

        .search-filter {
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 15px;
        }

        .search-input {
            background: var(--surface);
            border: 2px solid var(--border);
            color: var(--text);
            padding: 12px 20px;
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .filter-btn, .action-btn {
            background: var(--surface);
            border: 2px solid var(--border);
            color: var(--text);
            padding: 12px 24px;
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover, .action-btn:hover {
            border-color: var(--accent-green);
            background: var(--surface-light);
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--accent-green), #00cc70);
            color: var(--bg-dark);
            border: none;
            font-weight: 700;
        }

        .action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 255, 136, 0.4);
        }

        .action-btn.secondary {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .action-btn.secondary:hover {
            background: var(--accent-red);
            color: var(--bg-dark);
        }

        /* Selected Players Box */
        .selected-box {
            background: var(--surface-light);
            border: 2px solid var(--accent-green);
            padding: 20px;
            margin-bottom: 30px;
            display: none;
        }

        .selected-box.has-selections {
            display: block;
        }

        .selected-box h3 {
            font-size: 14px;
            color: var(--accent-green);
            margin-bottom: 15px;
        }

        .selected-players {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .selected-player-tag {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
        }

        .remove-player {
            color: var(--accent-red);
            cursor: pointer;
            font-weight: 700;
        }

        .remove-player:hover {
            color: #ff6688;
        }

        /* Player List */
        .player-list {
            display: grid;
            gap: 10px;
        }

        .player-item {
            background: var(--surface);
            border: 2px solid var(--border);
            padding: 15px 20px;
            display: grid;
            grid-template-columns: 40px 1fr auto auto;
            align-items: center;
            gap: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .player-item:hover {
            border-color: var(--accent-green);
            background: var(--surface-light);
        }

        .player-item.selected {
            border-color: var(--accent-green);
            background: rgba(0, 255, 136, 0.05);
        }

        .player-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-green);
        }

        .player-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .player-name {
            font-weight: 700;
            color: var(--text);
            font-size: 14px;
        }

        .player-meta {
            font-size: 11px;
            color: var(--text-dim);
        }

        .team-badge {
            background: var(--accent-blue);
            color: var(--bg-dark);
            padding: 2px 8px;
            font-weight: 700;
            font-size: 10px;
            margin-right: 8px;
        }

        .player-price {
            font-family: 'Space Mono', monospace;
            font-size: 18px;
            color: var(--accent-yellow);
            font-weight: 700;
        }

        .player-points {
            text-align: right;
        }

        .player-points-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-green);
        }

        .player-points-label {
            font-size: 10px;
            color: var(--text-dim);
        }

        /* Comparison View */
        .comparison-view {
            display: none;
        }

        .comparison-view.active {
            display: block;
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .comparison-header h2 {
            font-family: 'Space Mono', monospace;
            font-size: 28px;
            color: var(--accent-green);
        }

        .player-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 50px;
        }

        .player-card {
            background: var(--surface);
            border: 2px solid var(--border);
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .player-card:hover {
            border-color: var(--accent-green);
            transform: translateY(-3px);
        }

        .player-card-name {
            font-family: 'Space Mono', monospace;
            font-size: 18px;
            color: var(--accent-green);
            margin-bottom: 10px;
        }

        .player-card-price {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-yellow);
            margin-bottom: 8px;
        }

        .player-card-team {
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 15px;
        }

        .player-card-stat {
            font-size: 11px;
            color: var(--text-dim);
            margin: 5px 0;
        }

        .player-card-stat strong {
            color: var(--text);
        }

        .comparison-section {
            margin-bottom: 50px;
        }

        .comparison-section h3 {
            font-family: 'Space Mono', monospace;
            font-size: 20px;
            color: var(--accent-blue);
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        .comparison-table th {
            background: var(--surface-light);
            padding: 12px;
            text-align: left;
            font-weight: 700;
            border-bottom: 2px solid var(--accent-green);
            font-size: 12px;
        }

        .comparison-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }

        .comparison-table tr:hover {
            background: var(--surface-light);
        }

        .metric-label {
            color: var(--text);
            font-weight: 500;
        }

        .metric-value {
            text-align: center;
            font-family: 'Space Mono', monospace;
        }

        .metric-best {
            background: rgba(0, 255, 136, 0.15);
            color: var(--accent-green);
            font-weight: 700;
        }

        .section-header {
            background: var(--surface);
            padding: 10px 12px;
            font-weight: 700;
            color: var(--accent-yellow);
            border-left: 4px solid var(--accent-yellow);
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .chart-box {
            background: var(--surface);
            border: 2px solid var(--border);
            padding: 25px;
        }

        .chart-box h4 {
            font-family: 'Space Mono', monospace;
            font-size: 16px;
            color: var(--accent-blue);
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }

        .loading h3 {
            font-family: 'Space Mono', monospace;
            font-size: 20px;
            color: var(--accent-green);
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .no-players {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }
    </style>
</head>
<body>
    <button class="back-button" onclick="window.location.href='index.html'">‚Üê Back to Home</button>

    <div class="header">
        <h1>‚öñÔ∏è FPL Player Comparison</h1>
        <p>Compare up to 5 players from the same position side-by-side</p>
    </div>

    <div class="container">
        <!-- STEP 1: Position Selection -->
        <div id="positionSelector" class="position-selector">
            <h2>Choose a Position to Compare</h2>
            <div class="position-buttons">
                <button class="position-btn" onclick="selectPosition('GK')">
                    <span class="position-icon">üß§</span>
                    Goalkeepers
                </button>
                <button class="position-btn" onclick="selectPosition('DEF')">
                    <span class="position-icon">üõ°Ô∏è</span>
                    Defenders
                </button>
                <button class="position-btn" onclick="selectPosition('MID')">
                    <span class="position-icon">‚ö°</span>
                    Midfielders
                </button>
                <button class="position-btn" onclick="selectPosition('FWD')">
                    <span class="position-icon">üéØ</span>
                    Forwards
                </button>
            </div>
        </div>

        <!-- STEP 2: Player Selection -->
        <div id="playerSelection" class="selection-container">
            <div class="selection-header">
                <h2 id="positionTitle">Select Players</h2>
                <span class="selection-count" id="selectionCount">0/5 selected</span>
            </div>

            <div class="search-filter">
                <input 
                    type="text" 
                    class="search-input" 
                    id="searchInput" 
                    placeholder="üîç Search by name or team..."
                    onkeyup="filterPlayers()"
                >
                <button class="filter-btn" onclick="sortPlayers('points')">Sort by Points</button>
                <button class="filter-btn" onclick="sortPlayers('price')">Sort by Price</button>
            </div>

            <div class="selected-box" id="selectedBox">
                <h3>Selected Players:</h3>
                <div class="selected-players" id="selectedPlayers"></div>
            </div>

            <div class="player-list" id="playerList"></div>

            <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
                <button class="action-btn secondary" onclick="resetSelection()">‚Üê Change Position</button>
                <button class="action-btn primary" id="compareBtn" onclick="showComparison()" style="display: none;">
                    ‚öñÔ∏è Compare Players
                </button>
            </div>
        </div>

        <!-- STEP 3: Comparison View -->
        <div id="comparisonView" class="comparison-view">
            <div class="comparison-header">
                <h2 id="comparisonTitle">Comparison</h2>
                <button class="action-btn secondary" onclick="backToSelection()">‚Üª Compare Different Players</button>
            </div>

            <div class="player-cards" id="playerCards"></div>

            <div class="comparison-section">
                <h3>üìä Performance Metrics</h3>
                <div id="metricsTable"></div>
            </div>

            <div class="comparison-section">
                <h3>üìà Visual Comparison</h3>
                <div class="charts-container">
                    <div class="chart-box">
                        <h4>Season Performance</h4>
                        <canvas id="seasonChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <h4>Last 5 Games Form</h4>
                        <canvas id="l5Chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading" style="display: none;">
            <div class="spinner"></div>
            <h3>Loading player data...</h3>
            <p>This will only take a moment</p>
        </div>
    </div>

    <script>
        // Use Netlify function for CORS proxy
        const API_PROXY = '/.netlify/functions/fpl-proxy?url=';

        // Global state
        let bootstrapData = null;
        let playerDetails = null;
        let selectedPosition = null;
        let selectedPlayers = [];
        let filteredPlayers = [];
        const MAX_SELECTIONS = 5;

        // Position mapping
        const POSITIONS = {
            'GK': { id: 1, name: 'Goalkeepers', icon: 'üß§' },
            'DEF': { id: 2, name: 'Defenders', icon: 'üõ°Ô∏è' },
            'MID': { id: 3, name: 'Midfielders', icon: '‚ö°' },
            'FWD': { id: 4, name: 'Forwards', icon: 'üéØ' }
        };

        // Load data on page load
        window.addEventListener('DOMContentLoaded', loadData);

        async function loadData() {
            try {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('positionSelector').style.display = 'none';

                // Load bootstrap data
                bootstrapData = await fetchBootstrapData();
                
                // Load player details
                playerDetails = await loadPlayerDetails();

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('positionSelector').style.display = 'block';
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingState').innerHTML = `
                    <h3 style="color: var(--accent-red);">Error Loading Data</h3>
                    <p>Please refresh the page to try again.</p>
                `;
            }
        }

        async function fetchBootstrapData() {
            // Try cached file first
            try {
                const response = await fetch('/data/bootstrap-static.json');
                if (response.ok) {
                    console.log('‚úÖ Loaded bootstrap from cache');
                    return await response.json();
                }
            } catch (e) {
                console.log('No cached bootstrap, fetching from API...');
            }
            
            // Fallback to API
            const url = 'https://fantasy.premierleague.com/api/bootstrap-static/';
            const response = await fetch(API_PROXY + encodeURIComponent(url));
            if (!response.ok) throw new Error('Failed to fetch bootstrap data');
            return await response.json();
        }

        async function loadPlayerDetails() {
            try {
                const response = await fetch('/data/player-details.json');
                if (response.ok) {
                    console.log('‚úÖ Loaded player details from cache');
                    return await response.json();
                }
            } catch (e) {
                console.log('‚ÑπÔ∏è No cached player details');
            }
            return null;
        }

        function selectPosition(position) {
            selectedPosition = position;
            selectedPlayers = [];
            
            // Update UI
            document.getElementById('positionSelector').style.display = 'none';
            document.getElementById('playerSelection').classList.add('active');
            document.getElementById('positionTitle').textContent = `Select ${POSITIONS[position].name}`;
            
            // Filter and display players
            const positionId = POSITIONS[position].id;
            filteredPlayers = bootstrapData.elements
                .filter(p => p.element_type === positionId && p.minutes > 0)
                .map(p => ({
                    id: p.id,
                    name: p.web_name,
                    fullName: p.first_name + ' ' + p.second_name,
                    team: bootstrapData.teams.find(t => t.id === p.team).short_name,
                    position: position,
                    price: p.now_cost / 10,
                    points: p.total_points,
                    form: parseFloat(p.form),
                    minutes: p.minutes,
                    selected_by: parseFloat(p.selected_by_percent)
                }))
                .sort((a, b) => b.points - a.points);
            
            renderPlayerList();
        }

        function renderPlayerList() {
            const listContainer = document.getElementById('playerList');
            
            if (filteredPlayers.length === 0) {
                listContainer.innerHTML = '<div class="no-players">No players found</div>';
                return;
            }
            
            listContainer.innerHTML = filteredPlayers.map(player => {
                const isSelected = selectedPlayers.some(p => p.id === player.id);
                return `
                    <div class="player-item ${isSelected ? 'selected' : ''}" onclick="togglePlayer(${player.id})">
                        <input 
                            type="checkbox" 
                            class="player-checkbox" 
                            ${isSelected ? 'checked' : ''}
                            onclick="event.stopPropagation(); togglePlayer(${player.id})"
                        >
                        <div class="player-info">
                            <div class="player-name">${player.name}</div>
                            <div class="player-meta">
                                <span class="team-badge">${player.team}</span>
                                ${player.minutes} mins | ${player.form} form
                            </div>
                        </div>
                        <div class="player-price">¬£${player.price}m</div>
                        <div class="player-points">
                            <div class="player-points-value">${player.points}</div>
                            <div class="player-points-label">points</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function togglePlayer(playerId) {
            const player = filteredPlayers.find(p => p.id === playerId);
            const index = selectedPlayers.findIndex(p => p.id === playerId);
            
            if (index >= 0) {
                // Deselect
                selectedPlayers.splice(index, 1);
            } else {
                // Select
                if (selectedPlayers.length >= MAX_SELECTIONS) {
                    alert(`You can only compare up to ${MAX_SELECTIONS} players at once.`);
                    return;
                }
                selectedPlayers.push(player);
            }
            
            updateSelectionUI();
            renderPlayerList();
        }

        function updateSelectionUI() {
            const count = selectedPlayers.length;
            document.getElementById('selectionCount').textContent = `${count}/${MAX_SELECTIONS} selected`;
            
            // Show/hide selected box
            const selectedBox = document.getElementById('selectedBox');
            if (count > 0) {
                selectedBox.classList.add('has-selections');
                document.getElementById('selectedPlayers').innerHTML = selectedPlayers.map(p => `
                    <div class="selected-player-tag">
                        ${p.name} (${p.team})
                        <span class="remove-player" onclick="togglePlayer(${p.id})">‚úï</span>
                    </div>
                `).join('');
            } else {
                selectedBox.classList.remove('has-selections');
            }
            
            // Show/hide compare button
            const compareBtn = document.getElementById('compareBtn');
            if (count >= 2) {
                compareBtn.style.display = 'inline-block';
            } else {
                compareBtn.style.display = 'none';
            }
        }

        function filterPlayers() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            const positionId = POSITIONS[selectedPosition].id;
            filteredPlayers = bootstrapData.elements
                .filter(p => {
                    if (p.element_type !== positionId || p.minutes === 0) return false;
                    
                    const name = p.web_name.toLowerCase();
                    const fullName = (p.first_name + ' ' + p.second_name).toLowerCase();
                    const team = bootstrapData.teams.find(t => t.id === p.team).short_name.toLowerCase();
                    
                    return name.includes(search) || fullName.includes(search) || team.includes(search);
                })
                .map(p => ({
                    id: p.id,
                    name: p.web_name,
                    fullName: p.first_name + ' ' + p.second_name,
                    team: bootstrapData.teams.find(t => t.id === p.team).short_name,
                    position: selectedPosition,
                    price: p.now_cost / 10,
                    points: p.total_points,
                    form: parseFloat(p.form),
                    minutes: p.minutes,
                    selected_by: parseFloat(p.selected_by_percent)
                }));
            
            renderPlayerList();
        }

        function sortPlayers(by) {
            if (by === 'points') {
                filteredPlayers.sort((a, b) => b.points - a.points);
            } else if (by === 'price') {
                filteredPlayers.sort((a, b) => b.price - a.price);
            }
            renderPlayerList();
        }

        function resetSelection() {
            selectedPosition = null;
            selectedPlayers = [];
            document.getElementById('playerSelection').classList.remove('active');
            document.getElementById('positionSelector').style.display = 'block';
            document.getElementById('searchInput').value = '';
        }

        async function showComparison() {
            document.getElementById('playerSelection').classList.remove('active');
            document.getElementById('comparisonView').classList.add('active');
            document.getElementById('loadingState').style.display = 'block';
            
            // Load detailed stats for selected players
            await loadDetailedStats();
            
            document.getElementById('loadingState').style.display = 'none';
            renderComparison();
        }

        async function loadDetailedStats() {
            for (let player of selectedPlayers) {
                if (playerDetails && playerDetails[player.id]) {
                    // Use cached data
                    player.detailedStats = playerDetails[player.id];
                } else {
                    // Fetch from API
                    try {
                        const url = `https://fantasy.premierleague.com/api/element-summary/${player.id}/`;
                        const response = await fetch(API_PROXY + encodeURIComponent(url));
                        const data = await response.json();
                        player.detailedStats = data;
                    } catch (e) {
                        console.error(`Failed to load stats for ${player.name}`);
                        player.detailedStats = null;
                    }
                }
                
                // Calculate season and L5 stats
                if (player.detailedStats && player.detailedStats.history) {
                    player.seasonStats = calculateStats(player.detailedStats.history, false);
                    player.l5Stats = calculateStats(player.detailedStats.history, true);
                }
            }
        }

        function calculateStats(history, last5 = false) {
            const games = last5 ? history.slice(-5) : history;
            const numGames = games.length;
            
            if (numGames === 0) return null;

            const sum = (arr, key) => arr.reduce((acc, g) => acc + (parseFloat(g[key]) || 0), 0);
            
            return {
                games: numGames,
                minutes: sum(games, 'minutes'),
                points: sum(games, 'total_points'),
                goals: sum(games, 'goals_scored'),
                assists: sum(games, 'assists'),
                cleanSheets: sum(games, 'clean_sheets'),
                goalsConceded: sum(games, 'goals_conceded'),
                saves: sum(games, 'saves'),
                bonus: sum(games, 'bonus'),
                bps: sum(games, 'bps'),
                xG: sum(games, 'expected_goals'),
                xA: sum(games, 'expected_assists'),
                xGI: sum(games, 'expected_goal_involvements'),
                xGC: sum(games, 'expected_goals_conceded'),
                bigChancesCreated: sum(games, 'big_chances_created'),
                bigChancesMissed: sum(games, 'big_chances_missed'),
                keyPasses: sum(games, 'key_passes'),
                ict: sum(games, 'ict_index'),
                influence: sum(games, 'influence'),
                creativity: sum(games, 'creativity'),
                threat: sum(games, 'threat')
            };
        }

        function renderComparison() {
            const positionName = POSITIONS[selectedPosition].name;
            document.getElementById('comparisonTitle').textContent = `Comparing ${selectedPlayers.length} ${positionName}`;
            
            // Player cards
            renderPlayerCards();
            
            // Metrics table
            renderMetricsTable();
            
            // Charts
            setTimeout(() => renderCharts(), 100);
        }

        function renderPlayerCards() {
            document.getElementById('playerCards').innerHTML = selectedPlayers.map(p => `
                <div class="player-card">
                    <div class="player-card-name">${p.name}</div>
                    <div class="player-card-price">¬£${p.price}m</div>
                    <div class="player-card-team">${p.team}</div>
                    <div class="player-card-stat"><strong>${p.points}</strong> total points</div>
                    <div class="player-card-stat"><strong>${(p.points / p.price).toFixed(1)}</strong> pts per ¬£</div>
                    <div class="player-card-stat"><strong>${p.selected_by}%</strong> ownership</div>
                </div>
            `).join('');
        }

        function renderMetricsTable() {
            const metrics = getMetricsForPosition(selectedPosition);
            
            let html = '<table class="comparison-table"><thead><tr>';
            html += '<th class="metric-label">Metric</th>';
            selectedPlayers.forEach(p => {
                html += `<th class="metric-value">${p.name}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Season stats
            html += `<tr><td colspan="${selectedPlayers.length + 1}" class="section-header">SEASON STATS (Per Game)</td></tr>`;
            
            metrics.forEach(metric => {
                html += '<tr><td class="metric-label">' + metric.label + '</td>';
                
                const values = selectedPlayers.map(p => {
                    if (!p.seasonStats) return 0;
                    const val = p.seasonStats[metric.key];
                    return metric.perGame ? (val / p.seasonStats.games) : val;
                });
                
                const maxValue = Math.max(...values);
                const bestIsLowest = ['goalsConceded', 'xGC'].includes(metric.key);
                const minValue = Math.min(...values.filter(v => v > 0));
                
                selectedPlayers.forEach((p, i) => {
                    if (!p.seasonStats) {
                        html += '<td class="metric-value">-</td>';
                        return;
                    }
                    
                    const val = values[i];
                    const isBest = bestIsLowest ? (val === minValue && val > 0) : (val === maxValue && val > 0);
                    const displayVal = metric.decimals !== undefined ? val.toFixed(metric.decimals) : val;
                    html += `<td class="metric-value ${isBest ? 'metric-best' : ''}">${displayVal}</td>`;
                });
                
                html += '</tr>';
            });
            
            // Last 5 stats
            html += `<tr><td colspan="${selectedPlayers.length + 1}" class="section-header">LAST 5 GAMES (Per Game)</td></tr>`;
            
            metrics.forEach(metric => {
                html += '<tr><td class="metric-label">' + metric.label + '</td>';
                
                const values = selectedPlayers.map(p => {
                    if (!p.l5Stats) return 0;
                    const val = p.l5Stats[metric.key];
                    return metric.perGame ? (val / p.l5Stats.games) : val;
                });
                
                const maxValue = Math.max(...values);
                const bestIsLowest = ['goalsConceded', 'xGC'].includes(metric.key);
                const minValue = Math.min(...values.filter(v => v > 0));
                
                selectedPlayers.forEach((p, i) => {
                    if (!p.l5Stats) {
                        html += '<td class="metric-value">-</td>';
                        return;
                    }
                    
                    const val = values[i];
                    const isBest = bestIsLowest ? (val === minValue && val > 0) : (val === maxValue && val > 0);
                    const displayVal = metric.decimals !== undefined ? val.toFixed(metric.decimals) : val;
                    html += `<td class="metric-value ${isBest ? 'metric-best' : ''}">${displayVal}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            document.getElementById('metricsTable').innerHTML = html;
        }

        function getMetricsForPosition(position) {
            const common = [
                { key: 'points', label: 'Points', perGame: true, decimals: 1 },
                { key: 'minutes', label: 'Minutes', perGame: true, decimals: 0 },
            ];
            
            if (position === 'GK') {
                return [
                    ...common,
                    { key: 'cleanSheets', label: 'Clean Sheets %', perGame: true, decimals: 1 },
                    { key: 'saves', label: 'Saves', perGame: true, decimals: 1 },
                    { key: 'goalsConceded', label: 'Goals Conceded', perGame: true, decimals: 1 },
                    { key: 'xGC', label: 'xGC (lower = better)', perGame: true, decimals: 2 },
                    { key: 'bonus', label: 'Bonus Points', perGame: true, decimals: 1 },
                    { key: 'bps', label: 'BPS', perGame: true, decimals: 1 }
                ];
            } else if (position === 'DEF') {
                return [
                    ...common,
                    { key: 'cleanSheets', label: 'Clean Sheets %', perGame: true, decimals: 1 },
                    { key: 'goalsConceded', label: 'Goals Conceded', perGame: true, decimals: 1 },
                    { key: 'xGC', label: 'xGC (lower = better)', perGame: true, decimals: 2 },
                    { key: 'goals', label: 'Goals', perGame: true, decimals: 2 },
                    { key: 'assists', label: 'Assists', perGame: true, decimals: 2 },
                    { key: 'xG', label: 'xG', perGame: true, decimals: 2 },
                    { key: 'xA', label: 'xA', perGame: true, decimals: 2 },
                    { key: 'bigChancesCreated', label: 'Big Chances Created', perGame: true, decimals: 1 },
                    { key: 'bonus', label: 'Bonus Points', perGame: true, decimals: 1 }
                ];
            } else {
                return [
                    ...common,
                    { key: 'goals', label: 'Goals', perGame: true, decimals: 2 },
                    { key: 'assists', label: 'Assists', perGame: true, decimals: 2 },
                    { key: 'xG', label: 'xG (expected)', perGame: true, decimals: 2 },
                    { key: 'xA', label: 'xA (expected)', perGame: true, decimals: 2 },
                    { key: 'xGI', label: 'xGI (expected involvements)', perGame: true, decimals: 2 },
                    { key: 'bigChancesCreated', label: 'Big Chances Created', perGame: true, decimals: 1 },
                    { key: 'bigChancesMissed', label: 'Big Chances Missed', perGame: true, decimals: 1 },
                    { key: 'keyPasses', label: 'Key Passes', perGame: true, decimals: 1 },
                    { key: 'bonus', label: 'Bonus Points', perGame: true, decimals: 1 }
                ];
            }
        }

        function renderCharts() {
            const chartColors = [
                'rgba(0, 255, 136, 0.8)',
                'rgba(0, 204, 255, 0.8)',
                'rgba(255, 204, 0, 0.8)',
                'rgba(255, 51, 102, 0.8)',
                'rgba(138, 43, 226, 0.8)'
            ];
            
            let metrics;
            if (selectedPosition === 'GK') {
                metrics = ['points', 'cleanSheets', 'saves'];
            } else if (selectedPosition === 'DEF') {
                metrics = ['points', 'cleanSheets', 'goals', 'assists'];
            } else {
                metrics = ['points', 'goals', 'assists', 'xG', 'xA'];
            }
            
            // Season chart
            const seasonCtx = document.getElementById('seasonChart');
            if (seasonCtx && selectedPlayers[0].seasonStats) {
                new Chart(seasonCtx, {
                    type: 'bar',
                    data: {
                        labels: metrics.map(m => m.toUpperCase()),
                        datasets: selectedPlayers.map((p, i) => ({
                            label: p.name,
                            data: metrics.map(m => p.seasonStats ? (p.seasonStats[m] / p.seasonStats.games).toFixed(2) : 0),
                            backgroundColor: chartColors[i],
                            borderColor: chartColors[i].replace('0.8', '1'),
                            borderWidth: 2
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                labels: { color: '#e0e5ed', font: { family: 'DM Mono' } }
                            }
                        },
                        scales: {
                            y: {
                                ticks: { color: '#8b95a5', font: { family: 'DM Mono' } },
                                grid: { color: '#2a3340' }
                            },
                            x: {
                                ticks: { color: '#8b95a5', font: { family: 'DM Mono' } },
                                grid: { color: '#2a3340' }
                            }
                        }
                    }
                });
            }
            
            // L5 chart
            const l5Ctx = document.getElementById('l5Chart');
            if (l5Ctx && selectedPlayers[0].l5Stats) {
                new Chart(l5Ctx, {
                    type: 'bar',
                    data: {
                        labels: metrics.map(m => m.toUpperCase()),
                        datasets: selectedPlayers.map((p, i) => ({
                            label: p.name,
                            data: metrics.map(m => p.l5Stats ? (p.l5Stats[m] / p.l5Stats.games).toFixed(2) : 0),
                            backgroundColor: chartColors[i],
                            borderColor: chartColors[i].replace('0.8', '1'),
                            borderWidth: 2
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                labels: { color: '#e0e5ed', font: { family: 'DM Mono' } }
                            }
                        },
                        scales: {
                            y: {
                                ticks: { color: '#8b95a5', font: { family: 'DM Mono' } },
                                grid: { color: '#2a3340' }
                            },
                            x: {
                                ticks: { color: '#8b95a5', font: { family: 'DM Mono' } },
                                grid: { color: '#2a3340' }
                            }
                        }
                    }
                });
            }
        }

        function backToSelection() {
            document.getElementById('comparisonView').classList.remove('active');
            document.getElementById('playerSelection').classList.add('active');
        }
    </script>
</body>
</html>
