name: Update FPL Data Daily

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Create data directory
        run: mkdir -p data
      
      - name: Fetch and process FPL data
        run: |
          node << 'EOF'
          const fs = require('fs');
          
          async function fetchData() {
            console.log('Fetching bootstrap data...');
            const bootstrapRes = await fetch('https://fantasy.premierleague.com/api/bootstrap-static/');
            const bootstrap = await bootstrapRes.json();
            
            console.log('Fetching fixtures data...');
            const fixturesRes = await fetch('https://fantasy.premierleague.com/api/fixtures/');
            const fixtures = await fixturesRes.json();
            
            // Save main data
            fs.writeFileSync('data/bootstrap-static.json', JSON.stringify(bootstrap, null, 2));
            fs.writeFileSync('data/fixtures.json', JSON.stringify(fixtures, null, 2));
            
            console.log(`Fetching details for ${bootstrap.elements.length} players...`);
            const playerDetails = {};
            
            // Fetch player details in batches to avoid rate limiting
            for (let i = 0; i < bootstrap.elements.length; i++) {
              const player = bootstrap.elements[i];
              try {
                const res = await fetch(`https://fantasy.premierleague.com/api/element-summary/${player.id}/`);
                if (res.ok) {
                  playerDetails[player.id] = await res.json();
                  console.log(`âœ“ ${i + 1}/${bootstrap.elements.length} - ${player.web_name}`);
                } else {
                  console.log(`âœ— Failed: ${player.web_name}`);
                }
                // Small delay to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 100));
              } catch (error) {
                console.log(`âœ— Error fetching ${player.web_name}:`, error.message);
              }
            }
            
            // Save player details
            fs.writeFileSync('data/player-details.json', JSON.stringify(playerDetails, null, 2));
            console.log(`âœ… Saved details for ${Object.keys(playerDetails).length} players`);
          }
          
          fetchData().catch(console.error);
          EOF
      
      - name: Commit and push if changed
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add data/*.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ”„ Daily FPL data update [automated]" && git push)
