<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPL Transfer Wizard</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Space+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #0a0e14;
            --surface: #151920;
            --surface-light: #1d242e;
            --accent-green: #00ff88;
            --accent-red: #ff4757;
            --accent-yellow: #ffa502;
            --accent-blue: #00ccff;
            --accent-purple: #9b59b6;
            --text: #e0e5ed;
            --text-dim: #8b95a5;
            --border: #2a3340;
        }
        
        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'DM Mono', monospace;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--surface) 0%, var(--surface-light) 100%);
            border-bottom: 2px solid var(--accent-purple);
            padding: 20px 30px;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 {
            font-family: 'Space Mono', monospace;
            font-size: 24px;
            color: var(--accent-green);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .home-link {
            color: var(--text-dim);
            text-decoration: none;
            font-size: 12px;
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .home-link:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        
        /* Team ID Section */
        .team-id-section {
            background: var(--surface);
            padding: 25px 30px;
            border-bottom: 1px solid var(--border);
        }
        
        .team-id-inner {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .team-id-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .team-id-label {
            font-size: 14px;
            font-weight: 500;
        }
        
        .team-id-input {
            background: var(--bg);
            border: 2px solid var(--border);
            color: var(--text);
            padding: 12px 18px;
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 16px;
            width: 200px;
            transition: all 0.2s;
        }
        
        .team-id-input:focus {
            outline: none;
            border-color: var(--accent-green);
        }
        
        .load-btn {
            padding: 12px 28px;
            background: linear-gradient(135deg, var(--accent-green) 0%, #00cc70 100%);
            color: var(--bg);
            border: none;
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .load-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }
        
        .load-btn:disabled {
            opacity: 0.6;
            cursor: wait;
        }
        
        .manager-card {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px 25px;
            background: rgba(0, 255, 136, 0.08);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .manager-card.hidden { display: none; }
        
        .manager-name {
            font-family: 'Space Mono', monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-green);
        }
        
        .manager-stats {
            display: flex;
            gap: 25px;
        }
        
        .manager-stat {
            text-align: center;
        }
        
        .manager-stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 16px;
            font-weight: 600;
        }
        
        .manager-stat-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        .help-link {
            margin-left: auto;
            font-size: 11px;
            color: var(--text-dim);
        }
        
        .help-link a {
            color: var(--accent-blue);
        }
        
        /* Progress Bar */
        .progress-container {
            background: var(--surface-light);
            padding: 20px 30px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .progress-inner {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .wizard-progress {
            display: flex;
            justify-content: space-between;
            position: relative;
        }
        
        .wizard-progress::before {
            content: '';
            position: absolute;
            top: 22px;
            left: 60px;
            right: 60px;
            height: 3px;
            background: var(--border);
        }
        
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .progress-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg);
            border: 3px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .progress-step.active .progress-icon {
            border-color: var(--accent-green);
            background: var(--accent-green);
            color: var(--bg);
        }
        
        .progress-step.completed .progress-icon {
            border-color: var(--accent-green);
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
        }
        
        .progress-step.disabled { opacity: 0.4; pointer-events: none; }
        
        .progress-label {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        .progress-step.active .progress-label,
        .progress-step.completed .progress-label {
            color: var(--accent-green);
        }
        
        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }
        
        /* Step Panels */
        .step-panel {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        
        .step-panel.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .panel-header {
            margin-bottom: 25px;
        }
        
        .panel-header h2 {
            font-family: 'Space Mono', monospace;
            font-size: 24px;
            color: var(--accent-green);
            margin-bottom: 8px;
        }
        
        .panel-header p {
            font-size: 13px;
            color: var(--text-dim);
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-green) 0%, #00cc70 100%);
            color: var(--bg);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }
        
        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 2px solid var(--border);
        }
        
        .btn-secondary:hover:not(:disabled) { border-color: var(--accent-blue); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Status Bar */
        .status-bar {
            padding: 12px 20px;
            background: var(--surface);
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
        }
        
        .status-bar.loading { border-left: 4px solid var(--accent-yellow); }
        .status-bar.success { border-left: 4px solid var(--accent-green); }
        .status-bar.error { border-left: 4px solid var(--accent-red); }
        
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: var(--surface);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        /* Player Cards */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .player-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 18px;
            transition: all 0.2s ease;
        }
        
        .player-card.clickable {
            cursor: pointer;
        }
        
        .player-card.clickable:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }
        
        .player-card.sell-selected {
            border-color: var(--accent-red) !important;
            background: rgba(255, 71, 87, 0.1);
        }
        
        .player-card.buy-selected {
            border-color: var(--accent-green) !important;
            background: rgba(0, 255, 136, 0.1);
        }
        
        .player-card.urgent { border-left: 4px solid var(--accent-red); }
        .player-card.consider { border-left: 4px solid var(--accent-yellow); }
        .player-card.hold { border-left: 4px solid var(--accent-green); }
        
        .player-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .player-info h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .player-meta {
            font-size: 11px;
            color: var(--text-dim);
        }
        
        .player-rating { text-align: right; }
        
        .rating-value {
            font-family: 'Space Mono', monospace;
            font-size: 26px;
            font-weight: 700;
            line-height: 1;
        }
        
        .rating-value.urgent { color: var(--accent-red); }
        .rating-value.consider { color: var(--accent-yellow); }
        .rating-value.hold { color: var(--accent-green); }
        
        .rating-label {
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            padding: 3px 8px;
            border-radius: 4px;
            margin-top: 4px;
            display: inline-block;
        }
        
        .rating-label.urgent { background: var(--accent-red); color: white; }
        .rating-label.consider { background: var(--accent-yellow); color: var(--bg); }
        .rating-label.hold { background: var(--accent-green); color: var(--bg); }
        
        .player-issues {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }
        
        .issue-tag {
            font-size: 9px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .issue-tag.critical { background: rgba(255, 71, 87, 0.2); color: var(--accent-red); }
        .issue-tag.warning { background: rgba(255, 165, 2, 0.2); color: var(--accent-yellow); }
        .issue-tag.positive { background: rgba(0, 255, 136, 0.2); color: var(--accent-green); }
        .issue-tag.info { background: rgba(0, 204, 255, 0.2); color: var(--accent-blue); }
        
        .fixture-badges {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .fixture-badge {
            font-size: 9px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .fixture-badge.fdr-1, .fixture-badge.fdr-2 { background: rgba(0, 255, 136, 0.2); color: var(--accent-green); }
        .fixture-badge.fdr-3 { background: rgba(255, 165, 2, 0.2); color: var(--accent-yellow); }
        .fixture-badge.fdr-4, .fixture-badge.fdr-5 { background: rgba(255, 71, 87, 0.2); color: var(--accent-red); }
        
        /* Teams Grid */
        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .team-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .team-card:hover { border-color: var(--accent-blue); }
        
        .team-name {
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--accent-blue);
        }
        
        .team-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .team-stat {
            text-align: center;
            padding: 8px;
            background: var(--bg);
            border-radius: 6px;
        }
        
        .team-stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 18px;
            font-weight: 600;
        }
        
        .team-stat-label {
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        /* Budget Display */
        .budget-display {
            background: var(--surface);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            text-align: center;
        }
        
        .budget-item { padding: 0 15px; }
        
        .budget-value {
            font-family: 'Space Mono', monospace;
            font-size: 22px;
            font-weight: 700;
        }
        
        .budget-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-top: 4px;
        }
        
        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--surface);
            border-radius: 10px;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        .filter-select {
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'DM Mono', monospace;
            font-size: 11px;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: var(--accent-green);
        }
        
        /* Summary Box */
        .summary-box {
            background: var(--surface);
            border: 2px solid var(--accent-green);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .summary-title {
            font-family: 'Space Mono', monospace;
            font-size: 18px;
            color: var(--accent-green);
            margin-bottom: 20px;
        }
        
        .transfer-row {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .transfer-out, .transfer-in { flex: 1; }
        .transfer-out { text-align: right; }
        .transfer-arrow { font-size: 24px; color: var(--accent-green); }
        .transfer-player-name { font-weight: 600; font-size: 15px; }
        .transfer-player-team { font-size: 11px; color: var(--text-dim); }
        .transfer-player-price { font-family: 'DM Mono', monospace; font-size: 13px; margin-top: 4px; }
        .transfer-player-price.out { color: var(--accent-red); }
        .transfer-player-price.in { color: var(--accent-green); }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }
        
        .empty-state-icon { font-size: 64px; margin-bottom: 20px; }
        .empty-state h3 { font-size: 18px; color: var(--text); margin-bottom: 10px; }
        
        /* Navigation */
        .wizard-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        
        /* Scrollable */
        .scroll-container {
            max-height: 600px;
            overflow-y: auto;
        }
        
        /* Success Box */
        .success-box {
            background: rgba(0, 255, 136, 0.1);
            border: 2px solid var(--accent-green);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .success-box h4 { color: var(--accent-green); margin-bottom: 8px; }
        .success-box p { font-size: 12px; color: var(--text-dim); }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content { flex-direction: column; }
            .team-id-row { flex-direction: column; align-items: stretch; }
            .team-id-input { width: 100%; }
            .help-link { margin-left: 0; margin-top: 10px; }
            .manager-card { flex-direction: column; text-align: center; }
            .manager-stats { justify-content: center; }
            .wizard-progress::before { display: none; }
            .progress-label { display: none; }
            .players-grid { grid-template-columns: 1fr; }
            .transfer-row { flex-direction: column; text-align: center; }
            .transfer-out, .transfer-in { text-align: center; }
            .transfer-arrow { transform: rotate(90deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1>üßô‚Äç‚ôÇÔ∏è Transfer Wizard</h1>
            <a href="index.html" class="home-link">‚Üê Back to Tools</a>
        </div>
    </header>
    
    <!-- Team ID Input -->
    <div class="team-id-section">
        <div class="team-id-inner">
            <div class="team-id-row">
                <span class="team-id-label">üîë Your FPL Team ID:</span>
                <input type="text" id="teamIdInput" class="team-id-input" placeholder="e.g. 1234567">
                <button class="load-btn" id="loadBtn" onclick="loadTeamById()">Load My Team</button>
                <span class="help-link">
                    Find it at <a href="https://fantasy.premierleague.com" target="_blank">FPL</a> ‚Üí Points ‚Üí check URL for number
                </span>
            </div>
            
            <div class="manager-card hidden" id="managerCard">
                <div>
                    <div class="manager-name" id="managerName">-</div>
                    <div style="font-size: 11px; color: var(--text-dim);" id="teamName">-</div>
                </div>
                <div class="manager-stats">
                    <div class="manager-stat">
                        <div class="manager-stat-value" id="overallRank">-</div>
                        <div class="manager-stat-label">Overall Rank</div>
                    </div>
                    <div class="manager-stat">
                        <div class="manager-stat-value" id="totalPoints">-</div>
                        <div class="manager-stat-label">Total Points</div>
                    </div>
                    <div class="manager-stat">
                        <div class="manager-stat-value" style="color: var(--accent-green);" id="bankValue">-</div>
                        <div class="manager-stat-label">In The Bank</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="progress-inner">
            <div class="wizard-progress">
                <div class="progress-step active" onclick="goToStep(1)">
                    <div class="progress-icon">üìä</div>
                    <span class="progress-label">Analyze</span>
                </div>
                <div class="progress-step disabled" onclick="goToStep(2)">
                    <div class="progress-icon">üéØ</div>
                    <span class="progress-label">Select</span>
                </div>
                <div class="progress-step disabled" onclick="goToStep(3)">
                    <div class="progress-icon">üìÖ</div>
                    <span class="progress-label">Fixtures</span>
                </div>
                <div class="progress-step disabled" onclick="goToStep(4)">
                    <div class="progress-icon">üë§</div>
                    <span class="progress-label">Replace</span>
                </div>
                <div class="progress-step disabled" onclick="goToStep(5)">
                    <div class="progress-icon">‚úÖ</div>
                    <span class="progress-label">Review</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Status Bar -->
        <div id="statusBar" class="status-bar loading">
            <div class="spinner"></div>
            <span>Loading FPL data...</span>
        </div>
        
        <!-- Step 1: Analyze -->
        <div class="step-panel active" id="panel-1">
            <div class="panel-header">
                <h2>Step 1: Analyze Your Squad</h2>
                <p>Enter your FPL Team ID above and click "Load My Team". Your 15 players will be analyzed and sorted by sell priority (red = urgent sell, yellow = consider, green = hold).</p>
            </div>
            
            <div id="step1Content">
                <div class="empty-state">
                    <div class="empty-state-icon">‚öΩ</div>
                    <h3>No Team Loaded</h3>
                    <p>Enter your FPL Team ID above and click "Load My Team"</p>
                </div>
            </div>
            
            <div class="wizard-nav" id="nav1" style="display: none;">
                <div></div>
                <button class="btn btn-primary" onclick="goToStep(2)">Continue to Selection ‚Üí</button>
            </div>
        </div>
        
        <!-- Step 2: Select Players to Sell -->
        <div class="step-panel" id="panel-2">
            <div class="panel-header">
                <h2>Step 2: Select Players to Sell</h2>
                <p>Click on the players you want to transfer OUT. Your budget updates automatically.</p>
            </div>
            
            <div class="budget-display">
                <div class="budget-item">
                    <div class="budget-value" style="color: var(--accent-green);" id="itbDisplay">¬£0.0m</div>
                    <div class="budget-label">In The Bank</div>
                </div>
                <div class="budget-item">
                    <div class="budget-value" style="color: var(--accent-yellow);" id="sellValueDisplay">¬£0.0m</div>
                    <div class="budget-label">Selling Value</div>
                </div>
                <div class="budget-item">
                    <div class="budget-value" style="color: var(--accent-green);" id="totalBudgetDisplay">¬£0.0m</div>
                    <div class="budget-label">Total Budget</div>
                </div>
                <div class="budget-item">
                    <div class="budget-value" id="sellCountDisplay">0</div>
                    <div class="budget-label">Transfers Out</div>
                </div>
            </div>
            
            <div id="step2Content" class="players-grid"></div>
            
            <div class="wizard-nav">
                <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button>
                <button class="btn btn-primary" id="toStep3Btn" onclick="goToStep(3)" disabled>View Fixture Swings ‚Üí</button>
            </div>
        </div>
        
        <!-- Step 3: Fixture Analysis -->
        <div class="step-panel" id="panel-3">
            <div class="panel-header">
                <h2>Step 3: Explore Fixture Opportunities</h2>
                <p>Teams ranked by easiest upcoming fixtures. Click a team to filter replacements from that team.</p>
            </div>
            
            <div id="step3Content" class="teams-grid"></div>
            
            <div class="wizard-nav">
                <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Back</button>
                <button class="btn btn-primary" onclick="goToStep(4)">Find Replacements ‚Üí</button>
            </div>
        </div>
        
        <!-- Step 4: Find Replacements -->
        <div class="step-panel" id="panel-4">
            <div class="panel-header">
                <h2>Step 4: Choose Replacements</h2>
                <p>Select players to bring IN. Filter by position, price, and team.</p>
            </div>
            
            <div class="filter-bar">
                <div class="filter-group">
                    <span class="filter-label">Position:</span>
                    <select id="posFilter" class="filter-select" onchange="renderReplacements()">
                        <option value="all">All</option>
                        <option value="1">GK</option>
                        <option value="2">DEF</option>
                        <option value="3">MID</option>
                        <option value="4">FWD</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Max Price:</span>
                    <select id="priceFilterSelect" class="filter-select" onchange="renderReplacements()">
                        <option value="99">Any</option>
                        <option value="5.0">‚â§¬£5.0m</option>
                        <option value="6.0">‚â§¬£6.0m</option>
                        <option value="7.0">‚â§¬£7.0m</option>
                        <option value="8.0">‚â§¬£8.0m</option>
                        <option value="10.0">‚â§¬£10.0m</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Sort:</span>
                    <select id="sortSelect" class="filter-select" onchange="renderReplacements()">
                        <option value="score">Recommendation</option>
                        <option value="form">Form</option>
                        <option value="xgi">xGI/90</option>
                        <option value="price">Price ‚Üë</option>
                        <option value="fdr">Fixtures</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Team:</span>
                    <select id="teamFilterSelect" class="filter-select" onchange="renderReplacements()">
                        <option value="all">All Teams</option>
                    </select>
                </div>
            </div>
            
            <div class="budget-display">
                <div class="budget-item">
                    <div class="budget-value" style="color: var(--accent-green);" id="availBudgetDisplay">¬£0.0m</div>
                    <div class="budget-label">Available</div>
                </div>
                <div class="budget-item">
                    <div class="budget-value" style="color: var(--accent-yellow);" id="spendingDisplay">¬£0.0m</div>
                    <div class="budget-label">Spending</div>
                </div>
                <div class="budget-item">
                    <div class="budget-value" id="remainingDisplay">¬£0.0m</div>
                    <div class="budget-label">Remaining</div>
                </div>
                <div class="budget-item">
                    <div class="budget-value" id="buyCountDisplay">0</div>
                    <div class="budget-label">Transfers In</div>
                </div>
            </div>
            
            <div id="step4Content" class="scroll-container players-grid"></div>
            
            <div class="wizard-nav">
                <button class="btn btn-secondary" onclick="goToStep(3)">‚Üê Back</button>
                <button class="btn btn-primary" id="toStep5Btn" onclick="goToStep(5)" disabled>Review Plan ‚Üí</button>
            </div>
        </div>
        
        <!-- Step 5: Review -->
        <div class="step-panel" id="panel-5">
            <div class="panel-header">
                <h2>Step 5: Review Your Transfer Plan</h2>
                <p>Confirm your transfers before heading to the official FPL site.</p>
            </div>
            
            <div id="step5Content"></div>
            
            <div class="wizard-nav">
                <button class="btn btn-secondary" onclick="goToStep(4)">‚Üê Back</button>
                <button class="btn btn-primary" onclick="executePlan()">Save & Go to FPL ‚Üí</button>
            </div>
        </div>
    </main>
    
    <script>
        // ===== STATE =====
        let allPlayers = [];
        let allPlayersById = {};
        let teams = {};
        let teamFixtures = {};
        let currentGW = 1;
        let myTeam = [];
        let analyzedTeam = [];
        let toSell = new Set();
        let toSellPlayers = [];
        let toBuy = [];
        let toBuyIds = new Set();
        let itb = 0;
        let managerData = null;
        
        const POS = { 1: 'GK', 2: 'DEF', 3: 'MID', 4: 'FWD' };
        const PROXY = 'https://corsproxy.io/?';
        
        // ===== INIT =====
        async function init() {
            try {
                updateStatus('Loading FPL data...', 'loading');
                
                // Bootstrap data
                const bootRes = await fetch(PROXY + encodeURIComponent('https://fantasy.premierleague.com/api/bootstrap-static/'));
                const bootData = await bootRes.json();
                
                // Current GW
                const currEvent = bootData.events.find(e => e.is_current);
                currentGW = currEvent ? currEvent.id : 1;
                
                // Teams
                bootData.teams.forEach(t => {
                    teams[t.id] = {
                        id: t.id,
                        name: t.name,
                        short: t.short_name,
                        attackHome: t.strength_attack_home,
                        attackAway: t.strength_attack_away,
                        defHome: t.strength_defence_home,
                        defAway: t.strength_defence_away
                    };
                });
                
                // Fixtures
                const fixRes = await fetch(PROXY + encodeURIComponent('https://fantasy.premierleague.com/api/fixtures/'));
                const fixData = await fixRes.json();
                
                const upcoming = fixData.filter(f => !f.finished && f.event).sort((a,b) => a.event - b.event);
                
                Object.keys(teams).forEach(tid => {
                    const id = parseInt(tid);
                    const fx = upcoming.filter(f => f.team_h === id || f.team_a === id).slice(0, 5);
                    teamFixtures[id] = fx.map(f => ({
                        opp: f.team_h === id ? teams[f.team_a]?.short : teams[f.team_h]?.short,
                        fdr: f.team_h === id ? f.team_h_difficulty : f.team_a_difficulty,
                        home: f.team_h === id
                    }));
                });
                
                // Players
                bootData.elements.forEach(p => {
                    const fx = teamFixtures[p.team] || [];
                    const avgFDR = fx.length ? fx.slice(0,3).reduce((s,f) => s + f.fdr, 0) / Math.min(3, fx.length) : 3;
                    
                    const player = {
                        id: p.id,
                        name: p.web_name,
                        team: teams[p.team]?.short || '?',
                        teamId: p.team,
                        teamName: teams[p.team]?.name || '?',
                        pos: p.element_type,
                        posName: POS[p.element_type],
                        price: p.now_cost / 10,
                        form: parseFloat(p.form) || 0,
                        own: parseFloat(p.selected_by_percent) || 0,
                        mins: p.minutes,
                        pts: p.total_points,
                        status: p.status,
                        news: p.news || '',
                        chance: p.chance_of_playing_next_round,
                        xG: parseFloat(p.expected_goals) || 0,
                        xA: parseFloat(p.expected_assists) || 0,
                        xGI: parseFloat(p.expected_goal_involvements) || 0,
                        fixtures: fx,
                        avgFDR
                    };
                    
                    allPlayers.push(player);
                    allPlayersById[p.id] = player;
                });
                
                // Team filter options
                const teamSel = document.getElementById('teamFilterSelect');
                Object.values(teams).sort((a,b) => a.name.localeCompare(b.name)).forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.textContent = t.name;
                    teamSel.appendChild(opt);
                });
                
                updateStatus(`Loaded ${allPlayers.length} players ‚Ä¢ GW${currentGW}`, 'success');
                
                // Check saved team ID
                const savedId = localStorage.getItem('fpl_team_id');
                if (savedId) {
                    document.getElementById('teamIdInput').value = savedId;
                    loadTeamById();
                }
                
            } catch (err) {
                console.error(err);
                updateStatus('Error loading data. Please refresh.', 'error');
            }
        }
        
        // ===== LOAD TEAM BY ID =====
        async function loadTeamById() {
            const teamId = document.getElementById('teamIdInput').value.trim();
            if (!teamId || isNaN(teamId)) {
                alert('Please enter a valid FPL Team ID (numbers only)');
                return;
            }
            
            const btn = document.getElementById('loadBtn');
            btn.disabled = true;
            btn.textContent = 'Loading...';
            
            try {
                updateStatus(`Fetching team ${teamId}...`, 'loading');
                
                // Get manager info
                const mgrRes = await fetch(PROXY + encodeURIComponent(`https://fantasy.premierleague.com/api/entry/${teamId}/`));
                if (!mgrRes.ok) throw new Error('Team not found');
                managerData = await mgrRes.json();
                
                // Get picks
                const picksRes = await fetch(PROXY + encodeURIComponent(`https://fantasy.premierleague.com/api/entry/${teamId}/event/${currentGW}/picks/`));
                if (!picksRes.ok) throw new Error('Could not load team picks');
                const picksData = await picksRes.json();
                
                // Bank value
                itb = (picksData.entry_history?.bank || 0) / 10;
                
                // Map picks to players
                myTeam = picksData.picks.map(pick => {
                    const p = allPlayersById[pick.element];
                    return {
                        ...p,
                        isCaptain: pick.is_captain,
                        isVice: pick.is_vice_captain,
                        onBench: pick.position > 11
                    };
                });
                
                // Show manager card
                document.getElementById('managerName').textContent = `${managerData.player_first_name} ${managerData.player_last_name}`;
                document.getElementById('teamName').textContent = managerData.name;
                document.getElementById('overallRank').textContent = managerData.summary_overall_rank?.toLocaleString() || '-';
                document.getElementById('totalPoints').textContent = managerData.summary_overall_points || '-';
                document.getElementById('bankValue').textContent = `¬£${itb.toFixed(1)}m`;
                document.getElementById('managerCard').classList.remove('hidden');
                
                // Save for next time
                localStorage.setItem('fpl_team_id', teamId);
                
                updateStatus(`Loaded ${managerData.name} ‚Ä¢ ¬£${itb.toFixed(1)}m ITB`, 'success');
                
                // Analyze
                analyzeTeam();
                
            } catch (err) {
                console.error(err);
                updateStatus(`Error: ${err.message}`, 'error');
                document.getElementById('managerCard').classList.add('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Load My Team';
            }
        }
        
        // ===== ANALYZE TEAM =====
        function analyzeTeam() {
            if (myTeam.length !== 15) {
                document.getElementById('step1Content').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <h3>Team Error</h3>
                        <p>Expected 15 players, got ${myTeam.length}</p>
                    </div>
                `;
                return;
            }
            
            analyzedTeam = myTeam.map(p => {
                let score = 0;
                const issues = [];
                
                // Injury
                if (p.status === 'i' || p.status === 's') {
                    score += 50;
                    issues.push({ text: 'üî¥ Unavailable', type: 'critical' });
                } else if (p.status === 'd') {
                    score += 30;
                    issues.push({ text: 'üü° Doubtful', type: 'warning' });
                }
                
                if (p.chance !== null && p.chance < 50) {
                    score += 25;
                    issues.push({ text: `${p.chance}% chance`, type: 'critical' });
                }
                
                // Form
                if (p.form < 2) {
                    score += 35;
                    issues.push({ text: 'Poor Form', type: 'critical' });
                } else if (p.form < 3.5) {
                    score += 20;
                    issues.push({ text: 'Low Form', type: 'warning' });
                } else if (p.form >= 6) {
                    score -= 25;
                    issues.push({ text: 'Hot Form', type: 'positive' });
                } else if (p.form >= 4.5) {
                    score -= 10;
                    issues.push({ text: 'Good Form', type: 'positive' });
                }
                
                // xGI
                if (p.pos >= 3 && p.mins > 200) {
                    const xgi90 = (p.xGI / p.mins) * 90;
                    if (xgi90 < 0.25) {
                        score += 25;
                        issues.push({ text: 'Low xGI', type: 'warning' });
                    } else if (xgi90 >= 0.5) {
                        score -= 15;
                        issues.push({ text: 'High xGI', type: 'positive' });
                    }
                }
                
                // Fixtures
                if (p.avgFDR >= 4) {
                    score += 30;
                    issues.push({ text: 'Hard Fixtures', type: 'critical' });
                } else if (p.avgFDR >= 3.5) {
                    score += 15;
                    issues.push({ text: 'Tough Fixtures', type: 'warning' });
                } else if (p.avgFDR <= 2.5) {
                    score -= 20;
                    issues.push({ text: 'Easy Fixtures', type: 'positive' });
                } else if (p.avgFDR <= 3) {
                    score -= 10;
                    issues.push({ text: 'Good Fixtures', type: 'positive' });
                }
                
                // Ownership
                if (p.own >= 25) {
                    score -= 20;
                    issues.push({ text: 'üõ°Ô∏è Template', type: 'info' });
                } else if (p.own < 5) {
                    score += 10;
                    issues.push({ text: '‚öîÔ∏è Diff', type: 'info' });
                }
                
                // Bench
                if (p.onBench) {
                    score += 5;
                    issues.push({ text: 'Bench', type: 'info' });
                }
                
                score = Math.max(0, Math.min(100, score));
                
                let priority, action;
                if (score >= 60) { priority = 'urgent'; action = 'SELL'; }
                else if (score >= 35) { priority = 'consider'; action = 'CONSIDER'; }
                else { priority = 'hold'; action = 'HOLD'; }
                
                return { ...p, sellScore: score, issues, priority, action };
            });
            
            analyzedTeam.sort((a, b) => b.sellScore - a.sellScore);
            
            renderStep1();
            document.getElementById('nav1').style.display = 'flex';
            updateProgress(1);
        }
        
        // ===== RENDER STEP 1 =====
        function renderStep1() {
            const urgent = analyzedTeam.filter(p => p.priority === 'urgent').length;
            const consider = analyzedTeam.filter(p => p.priority === 'consider').length;
            const hold = 15 - urgent - consider;
            
            let html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" style="color: var(--accent-red);">${urgent}</div>
                        <div class="stat-label">Urgent Sells</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: var(--accent-yellow);">${consider}</div>
                        <div class="stat-label">Consider</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: var(--accent-green);">${hold}</div>
                        <div class="stat-label">Strong Holds</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: var(--accent-blue);">¬£${itb.toFixed(1)}m</div>
                        <div class="stat-label">In The Bank</div>
                    </div>
                </div>
                <div class="players-grid">
            `;
            
            analyzedTeam.forEach(p => {
                const fxHtml = p.fixtures?.slice(0, 3).map(f => `<span class="fixture-badge fdr-${f.fdr}">${f.opp}(${f.home ? 'H' : 'A'})</span>`).join('') || '';
                const cap = p.isCaptain ? '(C) ' : p.isVice ? '(V) ' : '';
                
                html += `
                    <div class="player-card ${p.priority}">
                        <div class="player-top">
                            <div class="player-info">
                                <h4>${cap}${p.name}</h4>
                                <span class="player-meta">${p.team} ‚Ä¢ ${p.posName} ‚Ä¢ ¬£${p.price.toFixed(1)}m ‚Ä¢ ${p.own.toFixed(1)}%</span>
                            </div>
                            <div class="player-rating">
                                <div class="rating-value ${p.priority}">${p.sellScore}</div>
                                <span class="rating-label ${p.priority}">${p.action}</span>
                            </div>
                        </div>
                        <div class="player-issues">${p.issues.map(i => `<span class="issue-tag ${i.type}">${i.text}</span>`).join('')}</div>
                        <div class="fixture-badges">${fxHtml}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('step1Content').innerHTML = html;
        }
        
        // ===== RENDER STEP 2 =====
        function renderStep2() {
            let html = '';
            
            analyzedTeam.forEach(p => {
                const selected = toSell.has(p.id);
                const fxHtml = p.fixtures?.slice(0, 3).map(f => `<span class="fixture-badge fdr-${f.fdr}">${f.opp}(${f.home ? 'H' : 'A'})</span>`).join('') || '';
                
                html += `
                    <div class="player-card clickable ${p.priority} ${selected ? 'sell-selected' : ''}" onclick="toggleSell(${p.id})">
                        <div class="player-top">
                            <div class="player-info">
                                <h4>${selected ? '‚úì ' : ''}${p.name}</h4>
                                <span class="player-meta">${p.team} ‚Ä¢ ${p.posName} ‚Ä¢ ¬£${p.price.toFixed(1)}m</span>
                            </div>
                            <div class="player-rating">
                                <div class="rating-value ${p.priority}">${p.sellScore}</div>
                                <span class="rating-label ${p.priority}">${p.action}</span>
                            </div>
                        </div>
                        <div class="player-issues">${p.issues.map(i => `<span class="issue-tag ${i.type}">${i.text}</span>`).join('')}</div>
                        <div class="fixture-badges">${fxHtml}</div>
                    </div>
                `;
            });
            
            document.getElementById('step2Content').innerHTML = html;
            updateBudgets();
        }
        
        function toggleSell(id) {
            if (toSell.has(id)) toSell.delete(id);
            else toSell.add(id);
            
            toSellPlayers = analyzedTeam.filter(p => toSell.has(p.id));
            renderStep2();
            document.getElementById('toStep3Btn').disabled = toSell.size === 0;
        }
        
        function updateBudgets() {
            const sellVal = toSellPlayers.reduce((s, p) => s + p.price, 0);
            const total = itb + sellVal;
            const spending = toBuy.reduce((s, p) => s + p.price, 0);
            
            document.getElementById('itbDisplay').textContent = `¬£${itb.toFixed(1)}m`;
            document.getElementById('sellValueDisplay').textContent = `¬£${sellVal.toFixed(1)}m`;
            document.getElementById('totalBudgetDisplay').textContent = `¬£${total.toFixed(1)}m`;
            document.getElementById('sellCountDisplay').textContent = toSell.size;
            
            document.getElementById('availBudgetDisplay').textContent = `¬£${total.toFixed(1)}m`;
            document.getElementById('spendingDisplay').textContent = `¬£${spending.toFixed(1)}m`;
            document.getElementById('remainingDisplay').textContent = `¬£${(total - spending).toFixed(1)}m`;
            document.getElementById('buyCountDisplay').textContent = toBuy.length;
        }
        
        // ===== RENDER STEP 3 =====
        function renderStep3() {
            const teamsData = Object.values(teams).map(t => {
                const fx = teamFixtures[t.id] || [];
                const avgFDR = fx.length ? fx.reduce((s, f) => s + f.fdr, 0) / fx.length : 3;
                return { ...t, fixtures: fx, avgFDR };
            }).sort((a, b) => a.avgFDR - b.avgFDR);
            
            let html = '';
            teamsData.slice(0, 12).forEach(t => {
                const color = t.avgFDR <= 2.5 ? 'var(--accent-green)' : t.avgFDR <= 3 ? 'var(--accent-yellow)' : 'var(--accent-red)';
                const icon = t.avgFDR <= 2.5 ? 'üü¢' : t.avgFDR <= 3 ? 'üü°' : 'üî¥';
                const fxHtml = t.fixtures.slice(0, 5).map(f => `<span class="fixture-badge fdr-${f.fdr}">${f.opp}(${f.home ? 'H' : 'A'})</span>`).join('');
                
                html += `
                    <div class="team-card" onclick="selectTeam(${t.id})">
                        <div class="team-name">${icon} ${t.name}</div>
                        <div class="team-stats">
                            <div class="team-stat">
                                <div class="team-stat-value" style="color: ${color};">${t.avgFDR.toFixed(1)}</div>
                                <div class="team-stat-label">Avg FDR</div>
                            </div>
                            <div class="team-stat">
                                <div class="team-stat-value">${Math.round((t.attackHome + t.attackAway) / 26 * 100)}%</div>
                                <div class="team-stat-label">Attack</div>
                            </div>
                        </div>
                        <div class="fixture-badges">${fxHtml}</div>
                    </div>
                `;
            });
            
            document.getElementById('step3Content').innerHTML = html;
        }
        
        function selectTeam(teamId) {
            document.getElementById('teamFilterSelect').value = teamId;
            goToStep(4);
        }
        
        // ===== RENDER STEP 4 =====
        function renderReplacements() {
            const posFilter = document.getElementById('posFilter').value;
            const maxPrice = parseFloat(document.getElementById('priceFilterSelect').value);
            const sortBy = document.getElementById('sortSelect').value;
            const teamFilter = document.getElementById('teamFilterSelect').value;
            
            const sellVal = toSellPlayers.reduce((s, p) => s + p.price, 0);
            const totalBudget = itb + sellVal;
            
            let filtered = allPlayers.filter(p => {
                if (myTeam.some(mp => mp.id === p.id) && !toSell.has(p.id)) return false;
                if (toBuyIds.has(p.id)) return false;
                if (posFilter !== 'all' && p.pos !== parseInt(posFilter)) return false;
                if (p.price > maxPrice) return false;
                if (teamFilter !== 'all' && p.teamId !== parseInt(teamFilter)) return false;
                if (p.status === 'i' || p.status === 's') return false;
                if (p.mins < 200) return false;
                return true;
            });
            
            filtered.forEach(p => {
                const xgi90 = p.mins > 0 ? (p.xGI / p.mins) * 90 : 0;
                const ppg = p.price > 0 ? p.pts / p.price : 0;
                p.recScore = (p.form * 2) + (xgi90 * 10) + (ppg * 0.5) + ((5 - p.avgFDR) * 3);
                if (p.avgFDR <= 2.5) p.recScore += 5;
            });
            
            switch (sortBy) {
                case 'form': filtered.sort((a, b) => b.form - a.form); break;
                case 'xgi': filtered.sort((a, b) => {
                    const aX = a.mins > 0 ? (a.xGI / a.mins) * 90 : 0;
                    const bX = b.mins > 0 ? (b.xGI / b.mins) * 90 : 0;
                    return bX - aX;
                }); break;
                case 'price': filtered.sort((a, b) => a.price - b.price); break;
                case 'fdr': filtered.sort((a, b) => a.avgFDR - b.avgFDR); break;
                default: filtered.sort((a, b) => b.recScore - a.recScore);
            }
            
            let html = '';
            filtered.slice(0, 50).forEach(p => {
                const xgi90 = p.mins > 0 ? (p.xGI / p.mins) * 90 : 0;
                const ppg = p.price > 0 ? p.pts / p.price : 0;
                const fxHtml = p.fixtures?.slice(0, 3).map(f => `<span class="fixture-badge fdr-${f.fdr}">${f.opp}(${f.home ? 'H' : 'A'})</span>`).join('') || '';
                const fdrColor = p.avgFDR <= 2.5 ? 'var(--accent-green)' : p.avgFDR <= 3 ? 'var(--accent-yellow)' : 'var(--accent-red)';
                
                html += `
                    <div class="player-card clickable" onclick="toggleBuy(${p.id})">
                        <div class="player-top">
                            <div class="player-info">
                                <h4>${p.name}</h4>
                                <span class="player-meta">${p.teamName} ‚Ä¢ ${p.posName} ‚Ä¢ ${p.own.toFixed(1)}%</span>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-family: 'Space Mono'; font-size: 20px; font-weight: 700; color: var(--accent-green);">¬£${p.price.toFixed(1)}m</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 12px; background: var(--bg); border-radius: 8px; margin: 10px 0;">
                            <div style="text-align: center;">
                                <div style="font-family: 'Space Mono'; font-size: 14px; font-weight: 600; color: var(--accent-green);">${p.form.toFixed(1)}</div>
                                <div style="font-size: 8px; color: var(--text-dim); text-transform: uppercase;">Form</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-family: 'Space Mono'; font-size: 14px; font-weight: 600; color: var(--accent-green);">${xgi90.toFixed(2)}</div>
                                <div style="font-size: 8px; color: var(--text-dim); text-transform: uppercase;">xGI/90</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-family: 'Space Mono'; font-size: 14px; font-weight: 600;">${ppg.toFixed(1)}</div>
                                <div style="font-size: 8px; color: var(--text-dim); text-transform: uppercase;">Pts/¬£m</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-family: 'Space Mono'; font-size: 14px; font-weight: 600; color: ${fdrColor};">${p.avgFDR.toFixed(1)}</div>
                                <div style="font-size: 8px; color: var(--text-dim); text-transform: uppercase;">FDR</div>
                            </div>
                        </div>
                        <div class="fixture-badges">${fxHtml}</div>
                    </div>
                `;
            });
            
            if (!html) html = '<div class="empty-state" style="grid-column: 1/-1;"><div class="empty-state-icon">üîç</div><h3>No Players Found</h3><p>Try adjusting filters</p></div>';
            
            document.getElementById('step4Content').innerHTML = html;
            updateBudgets();
        }
        
        function toggleBuy(id) {
            const p = allPlayersById[id];
            
            if (toBuyIds.has(id)) {
                toBuyIds.delete(id);
                toBuy = toBuy.filter(x => x.id !== id);
            } else {
                const sellVal = toSellPlayers.reduce((s, p) => s + p.price, 0);
                const totalBudget = itb + sellVal;
                const spending = toBuy.reduce((s, p) => s + p.price, 0);
                
                if (spending + p.price > totalBudget) {
                    alert('Not enough budget!');
                    return;
                }
                
                if (toBuy.length >= toSell.size) {
                    alert(`You can only bring in ${toSell.size} player(s)`);
                    return;
                }
                
                toBuyIds.add(id);
                toBuy.push(p);
            }
            
            updateBudgets();
            renderReplacements();
            document.getElementById('toStep5Btn').disabled = toBuy.length !== toSell.size;
        }
        
        // ===== RENDER STEP 5 =====
        function renderStep5() {
            const sellVal = toSellPlayers.reduce((s, p) => s + p.price, 0);
            const buyVal = toBuy.reduce((s, p) => s + p.price, 0);
            const net = buyVal - sellVal;
            
            const avgSellFDR = toSellPlayers.reduce((s, p) => s + p.avgFDR, 0) / toSellPlayers.length;
            const avgBuyFDR = toBuy.reduce((s, p) => s + p.avgFDR, 0) / toBuy.length;
            const fdrDiff = avgSellFDR - avgBuyFDR;
            
            const avgSellForm = toSellPlayers.reduce((s, p) => s + p.form, 0) / toSellPlayers.length;
            const avgBuyForm = toBuy.reduce((s, p) => s + p.form, 0) / toBuy.length;
            const formDiff = avgBuyForm - avgSellForm;
            
            let html = `<div class="summary-box"><div class="summary-title">üìã Transfer Summary</div>`;
            
            for (let i = 0; i < toSellPlayers.length; i++) {
                const out = toSellPlayers[i];
                const inp = toBuy[i];
                html += `
                    <div class="transfer-row">
                        <div class="transfer-out">
                            <div class="transfer-player-name">${out.name}</div>
                            <div class="transfer-player-team">${out.team} ‚Ä¢ ${out.posName}</div>
                            <div class="transfer-player-price out">-¬£${out.price.toFixed(1)}m</div>
                        </div>
                        <div class="transfer-arrow">‚Üí</div>
                        <div class="transfer-in">
                            <div class="transfer-player-name">${inp.name}</div>
                            <div class="transfer-player-team">${inp.team} ‚Ä¢ ${inp.posName}</div>
                            <div class="transfer-player-price in">+¬£${inp.price.toFixed(1)}m</div>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            
            const hit = toSellPlayers.length > 1 ? (toSellPlayers.length - 1) * -4 : 0;
            
            html += `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" style="color: ${net <= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                            ${net <= 0 ? '+' : '-'}¬£${Math.abs(net).toFixed(1)}m
                        </div>
                        <div class="stat-label">${net <= 0 ? 'Saved' : 'Spent'}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: ${fdrDiff > 0 ? 'var(--accent-green)' : 'var(--accent-yellow)'};">
                            ${fdrDiff > 0 ? '+' : ''}${fdrDiff.toFixed(1)}
                        </div>
                        <div class="stat-label">FDR ‚Üì</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: ${formDiff > 0 ? 'var(--accent-green)' : 'var(--accent-yellow)'};">
                            ${formDiff > 0 ? '+' : ''}${formDiff.toFixed(1)}
                        </div>
                        <div class="stat-label">Form ‚Üë</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: ${hit < 0 ? 'var(--accent-red)' : 'var(--accent-green)'};">${hit}</div>
                        <div class="stat-label">Hit</div>
                    </div>
                </div>
            `;
            
            if (fdrDiff > 0 && formDiff >= 0 && net <= 0) {
                html += `<div class="success-box"><h4>‚úÖ Smart Transfer</h4><p>Better fixtures, form improvement, and saving money!</p></div>`;
            } else if (fdrDiff > 0 || formDiff > 0) {
                html += `<div class="success-box" style="border-color: var(--accent-yellow); background: rgba(255, 165, 2, 0.1);"><h4 style="color: var(--accent-yellow);">‚ö° Good Move</h4><p>Solid improvements. Consider the trade-offs.</p></div>`;
            }
            
            document.getElementById('step5Content').innerHTML = html;
        }
        
        function executePlan() {
            localStorage.setItem('fpl_transfer_plan', JSON.stringify({
                date: new Date().toISOString(),
                out: toSellPlayers.map(p => ({ id: p.id, name: p.name })),
                in: toBuy.map(p => ({ id: p.id, name: p.name }))
            }));
            alert('Plan saved! Opening FPL...');
            window.open('https://fantasy.premierleague.com/transfers', '_blank');
        }
        
        // ===== NAVIGATION =====
        function goToStep(step) {
            if (step >= 2 && myTeam.length !== 15) { alert('Load your team first!'); return; }
            if (step >= 3 && toSell.size === 0) { alert('Select players to sell first!'); return; }
            if (step === 5 && toBuy.length !== toSell.size) { alert('Select all replacements first!'); return; }
            
            document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`panel-${step}`).classList.add('active');
            
            updateProgress(step);
            
            if (step === 2) renderStep2();
            else if (step === 3) renderStep3();
            else if (step === 4) {
                if (toSellPlayers.length === 1) document.getElementById('posFilter').value = toSellPlayers[0].pos;
                renderReplacements();
            }
            else if (step === 5) renderStep5();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function updateProgress(current) {
            document.querySelectorAll('.progress-step').forEach((el, i) => {
                el.classList.remove('active', 'completed', 'disabled');
                if (i + 1 < current) el.classList.add('completed');
                else if (i + 1 === current) el.classList.add('active');
                else if (i + 1 > current + 1) el.classList.add('disabled');
            });
        }
        
        function updateStatus(msg, type) {
            const bar = document.getElementById('statusBar');
            bar.className = `status-bar ${type}`;
            bar.innerHTML = type === 'loading' ? `<div class="spinner"></div><span>${msg}</span>` : `<span>${type === 'success' ? '‚úì' : '‚ö†'} ${msg}</span>`;
        }
        
        // Enter key to load
        document.getElementById('teamIdInput').addEventListener('keypress', e => { if (e.key === 'Enter') loadTeamById(); });
        
        window.addEventListener('load', init);
    </script>
</body>
</html>
