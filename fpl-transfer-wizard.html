<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPL Transfer Wizard</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Space+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #0a0e14;
            --surface: #151920;
            --surface-light: #1d242e;
            --accent-green: #00ff88;
            --accent-red: #ff4757;
            --accent-yellow: #ffa502;
            --accent-blue: #00ccff;
            --accent-purple: #9b59b6;
            --text: #e0e5ed;
            --text-dim: #8b95a5;
            --border: #2a3340;
        }
        
        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'DM Mono', monospace;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--surface) 0%, var(--surface-light) 100%);
            border-bottom: 2px solid var(--accent-purple);
            padding: 20px 30px;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 {
            font-family: 'Space Mono', monospace;
            font-size: 24px;
            color: var(--accent-green);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .home-link {
            color: var(--text-dim);
            text-decoration: none;
            font-size: 12px;
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .home-link:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        
        /* Team ID Section */
        .team-id-section {
            background: var(--surface);
            padding: 25px 30px;
            border-bottom: 1px solid var(--border);
        }
        
        .team-id-inner {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .team-id-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .team-id-label {
            font-size: 14px;
            font-weight: 500;
        }
        
        .team-id-input {
            background: var(--bg);
            border: 2px solid var(--border);
            color: var(--text);
            padding: 12px 18px;
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 16px;
            width: 200px;
            transition: all 0.2s;
        }
        
        .team-id-input:focus {
            outline: none;
            border-color: var(--accent-green);
        }
        
        .load-btn {
            padding: 12px 28px;
            background: linear-gradient(135deg, var(--accent-green) 0%, #00cc70 100%);
            color: var(--bg);
            border: none;
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .load-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }
        
        .load-btn:disabled {
            opacity: 0.6;
            cursor: wait;
        }
        
        .manager-card {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px 25px;
            background: rgba(0, 255, 136, 0.08);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .manager-card.hidden { display: none; }
        
        .manager-name {
            font-family: 'Space Mono', monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-green);
        }
        
        .manager-stats {
            display: flex;
            gap: 25px;
        }
        
        .manager-stat {
            text-align: center;
        }
        
        .manager-stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 16px;
            font-weight: 600;
        }
        
        .manager-stat-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        .help-link {
            margin-left: auto;
            font-size: 11px;
            color: var(--text-dim);
        }
        
        .help-link a {
            color: var(--accent-blue);
        }
        
        /* Progress Bar */
        .progress-container {
            background: var(--surface-light);
            padding: 20px 30px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .progress-bar {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .progress-bar::before {
            content: '';
            position: absolute;
            top: 18px;
            left: 40px;
            right: 40px;
            height: 2px;
            background: var(--border);
            z-index: 0;
        }
        
        .progress-step {
            position: relative;
            z-index: 1;
            background: var(--surface-light);
            padding: 0 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .progress-step.disabled { opacity: 0.4; cursor: not-allowed; }
        
        .step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--surface);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.3s;
        }
        
        .progress-step.completed .step-number {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: var(--bg);
        }
        
        .progress-step.active .step-number {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
            color: white;
            box-shadow: 0 0 20px rgba(155, 89, 182, 0.5);
        }
        
        .step-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .progress-step.active .step-label { color: var(--accent-purple); font-weight: 600; }
        .progress-step.completed .step-label { color: var(--accent-green); }
        
        /* Status Bar */
        .status-bar {
            max-width: 1400px;
            margin: 15px auto 0;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-bar.loading {
            background: rgba(0, 204, 255, 0.1);
            border: 1px solid rgba(0, 204, 255, 0.3);
            color: var(--accent-blue);
        }
        
        .status-bar.success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: var(--accent-green);
        }
        
        .status-bar.error {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid rgba(255, 71, 87, 0.3);
            color: var(--accent-red);
        }
        
        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid var(--accent-blue);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }
        
        .step-panel {
            display: none;
        }
        
        .step-panel.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .step-header {
            margin-bottom: 30px;
        }
        
        .step-title {
            font-family: 'Space Mono', monospace;
            font-size: 28px;
            color: var(--accent-green);
            margin-bottom: 8px;
        }
        
        .step-subtitle {
            color: var(--text-dim);
            font-size: 14px;
        }
        
        /* Formation Grid */
        .formation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .position-group {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 18px;
        }
        
        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        
        .position-name {
            font-family: 'Space Mono', monospace;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .position-count {
            font-size: 11px;
            color: var(--text-dim);
        }
        
        .player-card {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .player-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }
        
        .player-card.selected {
            border-color: var(--accent-red);
            background: rgba(255, 71, 87, 0.08);
        }
        
        .player-card.selected::before {
            content: '√ó';
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 20px;
            color: var(--accent-red);
            font-weight: 700;
        }
        
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .player-name {
            font-family: 'Space Mono', monospace;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .player-team {
            font-size: 11px;
            color: var(--text-dim);
        }
        
        .player-price {
            font-family: 'Space Mono', monospace;
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-green);
        }
        
        .player-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-green);
        }
        
        .stat-label {
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        /* Filters */
        .filters {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        select, input[type="range"] {
            background: var(--bg);
            border: 2px solid var(--border);
            color: var(--text);
            padding: 10px 14px;
            border-radius: 8px;
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--accent-green);
        }
        
        select option {
            background: var(--surface);
            color: var(--text);
        }
        
        /* Multi-select for teams */
        .team-filter-container {
            position: relative;
        }
        
        .team-filter-display {
            background: var(--bg);
            border: 2px solid var(--border);
            color: var(--text);
            padding: 10px 14px;
            border-radius: 8px;
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 42px;
        }
        
        .team-filter-display:hover {
            border-color: var(--accent-green);
        }
        
        .team-filter-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 8px;
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .team-filter-dropdown.show {
            display: block;
        }
        
        .team-filter-option {
            padding: 10px 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .team-filter-option:hover {
            background: var(--bg);
        }
        
        .team-filter-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .team-filter-option.all {
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            color: var(--accent-green);
        }
        
        /* Range slider */
        input[type="range"] {
            padding: 0;
            height: 6px;
            background: var(--border);
            border: none;
            border-radius: 3px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent-green);
            border-radius: 50%;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--accent-green);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .range-value {
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            color: var(--accent-green);
            font-weight: 600;
        }
        
        /* Player Grid */
        .player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 15px;
        }
        
        .market-player-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .market-player-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }
        
        .market-player-card.selected {
            border-color: var(--accent-green);
            background: rgba(0, 255, 136, 0.08);
        }
        
        .market-player-card.selected::before {
            content: '‚úì';
            position: absolute;
            top: 12px;
            right: 16px;
            font-size: 18px;
            color: var(--accent-green);
            font-weight: 700;
        }
        
        .player-info h4 {
            font-family: 'Space Mono', monospace;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .player-meta {
            font-size: 11px;
            color: var(--text-dim);
        }
        
        .fixture-badges {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        
        .fixture-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            font-family: 'Space Mono', monospace;
        }
        
        .fdr-2 { background: #4CAF50; color: white; }
        .fdr-3 { background: #8BC34A; color: white; }
        .fdr-4 { background: #FFC107; color: #333; }
        .fdr-5 { background: #FF5722; color: white; }
        
        /* Buttons */
        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 10px;
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-green) 0%, #00cc70 100%);
            color: var(--bg);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 2px solid var(--border);
        }
        
        .btn-secondary:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        
        /* Summary Boxes */
        .summary-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .summary-title {
            font-family: 'Space Mono', monospace;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .transfer-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .transfer-row:last-child {
            border-bottom: none;
        }
        
        .transfer-out, .transfer-in {
            padding: 12px;
            border-radius: 8px;
        }
        
        .transfer-out {
            background: rgba(255, 71, 87, 0.08);
            border: 1px solid rgba(255, 71, 87, 0.2);
        }
        
        .transfer-in {
            background: rgba(0, 255, 136, 0.08);
            border: 1px solid rgba(0, 255, 136, 0.2);
        }
        
        .transfer-player-name {
            font-family: 'Space Mono', monospace;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .transfer-player-team {
            font-size: 11px;
            color: var(--text-dim);
            margin-bottom: 8px;
        }
        
        .transfer-player-price {
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            font-weight: 700;
        }
        
        .transfer-player-price.out { color: var(--accent-red); }
        .transfer-player-price.in { color: var(--accent-green); }
        
        .transfer-arrow {
            font-size: 24px;
            color: var(--accent-blue);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-box {
            background: rgba(0, 204, 255, 0.08);
            border: 1px solid rgba(0, 204, 255, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .info-box h4 {
            color: var(--accent-blue);
            font-family: 'Space Mono', monospace;
            font-size: 16px;
            margin-bottom: 12px;
        }
        
        .info-box p {
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-dim);
        }
        
        .info-box ul {
            margin-top: 12px;
            padding-left: 20px;
        }
        
        .info-box li {
            font-size: 13px;
            line-height: 1.8;
            color: var(--text);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .empty-state h3 {
            font-family: 'Space Mono', monospace;
            font-size: 20px;
            margin-bottom: 8px;
        }
        
        /* Budget Display */
        .budget-display {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .budget-item {
            text-align: center;
        }
        
        .budget-value {
            font-family: 'Space Mono', monospace;
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-green);
        }
        
        .budget-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-top: 4px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 { font-size: 20px; }
            .step-title { font-size: 22px; }
            .formation-grid { grid-template-columns: 1fr; }
            .player-grid { grid-template-columns: 1fr; }
            .filter-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .transfer-row { grid-template-columns: 1fr; gap: 10px; }
            .transfer-arrow { display: none; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>‚ö° FPL Transfer Wizard</h1>
            <a href="#" class="home-link">‚Üê Back to Dashboard</a>
        </div>
    </div>
    
    <!-- Team ID Section -->
    <div class="team-id-section">
        <div class="team-id-inner">
            <div class="team-id-row">
                <span class="team-id-label">Team ID:</span>
                <input type="number" id="teamIdInput" class="team-id-input" placeholder="Enter your ID">
                <button class="load-btn" onclick="loadTeamById()">Load Team</button>
                <div class="help-link">
                    <a href="https://www.premierleague.com/news/2174878" target="_blank">Where do I find my Team ID?</a>
                </div>
            </div>
            <div id="managerCard" class="manager-card hidden">
                <div class="manager-name" id="managerName"></div>
                <div class="manager-stats">
                    <div class="manager-stat">
                        <div class="manager-stat-value" id="managerRank"></div>
                        <div class="manager-stat-label">Overall Rank</div>
                    </div>
                    <div class="manager-stat">
                        <div class="manager-stat-value" id="managerPoints"></div>
                        <div class="manager-stat-label">Total Points</div>
                    </div>
                    <div class="manager-stat">
                        <div class="manager-stat-value" id="managerValue"></div>
                        <div class="manager-stat-label">Team Value</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="progress-bar">
            <div class="progress-step active" onclick="goToStep(1)">
                <div class="step-number">1</div>
                <div class="step-label">Load Team</div>
            </div>
            <div class="progress-step" onclick="goToStep(2)">
                <div class="step-number">2</div>
                <div class="step-label">Select Players</div>
            </div>
            <div class="progress-step" onclick="goToStep(3)">
                <div class="step-number">3</div>
                <div class="step-label">Browse Market</div>
            </div>
            <div class="progress-step" onclick="goToStep(4)">
                <div class="step-number">4</div>
                <div class="step-label">Review</div>
            </div>
        </div>
        <div id="statusBar" class="status-bar" style="display: none;"></div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Step 1: Load Team -->
        <div id="panel-1" class="step-panel active">
            <div class="step-header">
                <h2 class="step-title">üè† Welcome</h2>
                <p class="step-subtitle">Enter your Team ID above to get started with smart transfer planning</p>
            </div>
            
            <div class="summary-box">
                <h3 style="margin-bottom: 15px;">How It Works</h3>
                <p style="margin-bottom: 15px;">This wizard helps you make data-driven transfer decisions in 4 simple steps:</p>
                <ol style="padding-left: 25px; line-height: 2;">
                    <li><strong>Load Your Team:</strong> Enter your FPL Team ID to import your current squad</li>
                    <li><strong>Select Players:</strong> Choose which players you want to transfer out</li>
                    <li><strong>Browse Market:</strong> Find the best replacements using fixtures, form, and stats</li>
                    <li><strong>Review:</strong> See a complete breakdown of your transfers before executing</li>
                </ol>
            </div>
        </div>
        
        <!-- Step 2: Select Players (Combined Analyse + Select) -->
        <div id="panel-2" class="step-panel">
            <div class="step-header">
                <h2 class="step-title">üë• Your Squad</h2>
                <p class="step-subtitle">Click on players you want to transfer out</p>
            </div>
            
            <div id="step2Content"></div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button>
                <button class="btn btn-primary" id="toStep3Btn" onclick="goToStep(3)" disabled>Continue ‚Üí</button>
            </div>
        </div>
        
        <!-- Step 3: Browse Market (was Step 4) -->
        <div id="panel-3" class="step-panel">
            <div class="step-header">
                <h2 class="step-title">üõí Browse Market</h2>
                <p class="step-subtitle">Find the perfect replacements for your squad</p>
            </div>
            
            <div class="budget-display" id="budgetDisplay"></div>
            
            <div class="filters">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">Position</label>
                        <select id="posFilter" onchange="renderReplacements()">
                            <option value="">All Positions</option>
                            <option value="1">Goalkeeper</option>
                            <option value="2">Defender</option>
                            <option value="3">Midfielder</option>
                            <option value="4">Forward</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Teams (Fixtures)</label>
                        <div class="team-filter-container">
                            <div class="team-filter-display" id="teamFilterDisplay" onclick="toggleTeamDropdown()">
                                <span id="teamFilterText">All Teams</span>
                                <span>‚ñº</span>
                            </div>
                            <div class="team-filter-dropdown" id="teamFilterDropdown"></div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Sort By</label>
                        <select id="sortFilter" onchange="renderReplacements()">
                            <option value="form">Form</option>
                            <option value="xgi">xGI per 90</option>
                            <option value="fdr">Fixture Difficulty</option>
                            <option value="own">Ownership</option>
                            <option value="ppg">Points per ¬£m</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Max Price: <span class="range-value" id="priceValue">¬£15.0m</span></label>
                        <input type="range" id="priceFilter" min="4" max="15" step="0.1" value="15" oninput="updatePriceLabel(); renderReplacements()">
                    </div>
                </div>
            </div>
            
            <div id="step4Content" class="player-grid"></div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Back</button>
                <button class="btn btn-primary" id="toStep5Btn" onclick="goToStep(4)" disabled>Review Transfers ‚Üí</button>
            </div>
        </div>
        
        <!-- Step 4: Review (was Step 5) -->
        <div id="panel-4" class="step-panel">
            <div class="step-header">
                <h2 class="step-title">üìä Transfer Review</h2>
                <p class="step-subtitle">Review your transfer details before executing</p>
            </div>
            
            <div id="step5Content"></div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="goToStep(3)">‚Üê Back</button>
                <button class="btn btn-primary" onclick="executePlan()">Execute on FPL ‚Üí</button>
            </div>
        </div>
    </div>
    
    <script>
        // ===== GLOBAL STATE =====
        let bootstrapData = null;
        let allPlayers = [];
        let allPlayersById = {};
        let fixturesData = [];
        let myTeam = [];
        let toSell = new Set();
        let toSellPlayers = [];
        let toBuy = [];
        let toBuyIds = new Set();
        let itb = 0;
        
        // Team filter state
        let selectedTeams = new Set();
        let allTeamsSelected = true;
        
        // ===== INITIALIZATION =====
        async function init() {
            updateStatus('Loading FPL data...', 'loading');
            try {
                const [bData, fData] = await Promise.all([
                    fetch('https://fantasy.premierleague.com/api/bootstrap-static/').then(r => r.json()),
                    fetch('https://fantasy.premierleague.com/api/fixtures/').then(r => r.json())
                ]);
                
                bootstrapData = bData;
                fixturesData = fData;
                
                const teamMap = {};
                bData.teams.forEach(t => teamMap[t.id] = t.short_name);
                
                const posMap = { 1: 'GKP', 2: 'DEF', 3: 'MID', 4: 'FWD' };
                
                allPlayers = bData.elements.map(p => {
                    const nextFx = fixturesData
                        .filter(f => !f.finished && (f.team_h === p.team || f.team_a === p.team))
                        .sort((a, b) => a.event - b.event)
                        .slice(0, 3);
                    
                    const fdrSum = nextFx.reduce((s, f) => {
                        return s + (f.team_h === p.team ? f.team_h_difficulty : f.team_a_difficulty);
                    }, 0);
                    
                    return {
                        id: p.id,
                        name: p.web_name,
                        fullName: `${p.first_name} ${p.second_name}`,
                        team: p.team,
                        teamName: teamMap[p.team],
                        pos: p.element_type,
                        posName: posMap[p.element_type],
                        price: p.now_cost / 10,
                        form: parseFloat(p.form) || 0,
                        own: parseFloat(p.selected_by_percent) || 0,
                        xgi: (parseFloat(p.expected_goal_involvements) || 0),
                        minutes: parseInt(p.minutes) || 1,
                        totalPts: parseInt(p.total_points) || 0,
                        fixtures: nextFx.map(f => ({
                            opp: f.team_h === p.team ? teamMap[f.team_a] : teamMap[f.team_h],
                            isHome: f.team_h === p.team,
                            fdr: f.team_h === p.team ? f.team_h_difficulty : f.team_a_difficulty
                        })),
                        avgFDR: nextFx.length > 0 ? fdrSum / nextFx.length : 3
                    };
                });
                
                allPlayers.forEach(p => allPlayersById[p.id] = p);
                
                updateStatus('Ready! Enter your Team ID to begin', 'success');
                initializeTeamFilter();
            } catch (e) {
                updateStatus('Failed to load FPL data. Please refresh.', 'error');
                console.error(e);
            }
        }
        
        // ===== TEAM FILTER =====
        function initializeTeamFilter() {
            const teams = bootstrapData.teams.sort((a, b) => a.name.localeCompare(b.name));
            const dropdown = document.getElementById('teamFilterDropdown');
            
            let html = `
                <div class="team-filter-option all" onclick="toggleAllTeams()">
                    <input type="checkbox" id="team-all" ${allTeamsSelected ? 'checked' : ''}>
                    <label for="team-all">All Teams</label>
                </div>
            `;
            
            teams.forEach(team => {
                html += `
                    <div class="team-filter-option" onclick="toggleTeam(${team.id})">
                        <input type="checkbox" id="team-${team.id}" ${allTeamsSelected ? 'checked' : ''}>
                        <label for="team-${team.id}">${team.name}</label>
                    </div>
                `;
            });
            
            dropdown.innerHTML = html;
        }
        
        function toggleTeamDropdown() {
            const dropdown = document.getElementById('teamFilterDropdown');
            dropdown.classList.toggle('show');
        }
        
        function toggleAllTeams() {
            allTeamsSelected = !allTeamsSelected;
            selectedTeams.clear();
            
            if (allTeamsSelected) {
                bootstrapData.teams.forEach(t => selectedTeams.add(t.id));
            }
            
            // Update checkboxes
            document.getElementById('team-all').checked = allTeamsSelected;
            bootstrapData.teams.forEach(team => {
                document.getElementById(`team-${team.id}`).checked = allTeamsSelected;
            });
            
            updateTeamFilterDisplay();
            renderReplacements();
        }
        
        function toggleTeam(teamId) {
            if (selectedTeams.has(teamId)) {
                selectedTeams.delete(teamId);
            } else {
                selectedTeams.add(teamId);
            }
            
            // Update all teams checkbox
            allTeamsSelected = selectedTeams.size === bootstrapData.teams.length;
            document.getElementById('team-all').checked = allTeamsSelected;
            document.getElementById(`team-${teamId}`).checked = selectedTeams.has(teamId);
            
            updateTeamFilterDisplay();
            renderReplacements();
        }
        
        function updateTeamFilterDisplay() {
            const display = document.getElementById('teamFilterText');
            if (allTeamsSelected) {
                display.textContent = 'All Teams';
            } else if (selectedTeams.size === 0) {
                display.textContent = 'No teams selected';
            } else if (selectedTeams.size === 1) {
                const teamId = Array.from(selectedTeams)[0];
                const team = bootstrapData.teams.find(t => t.id === teamId);
                display.textContent = team.name;
            } else {
                display.textContent = `${selectedTeams.size} teams selected`;
            }
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const container = document.querySelector('.team-filter-container');
            const dropdown = document.getElementById('teamFilterDropdown');
            if (container && !container.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        // ===== LOAD TEAM =====
        async function loadTeamById() {
            const teamId = document.getElementById('teamIdInput').value;
            if (!teamId) { alert('Please enter a Team ID'); return; }
            
            updateStatus('Loading your team...', 'loading');
            document.querySelector('.load-btn').disabled = true;
            
            try {
                const res = await fetch(`https://fantasy.premierleague.com/api/entry/${teamId}/`);
                if (!res.ok) throw new Error('Team not found');
                
                const team = await res.json();
                
                document.getElementById('managerName').textContent = `${team.player_first_name} ${team.player_last_name}`;
                document.getElementById('managerRank').textContent = team.summary_overall_rank.toLocaleString();
                document.getElementById('managerPoints').textContent = team.summary_overall_points.toLocaleString();
                document.getElementById('managerValue').textContent = `¬£${(team.last_deadline_value / 10).toFixed(1)}m`;
                document.getElementById('managerCard').classList.remove('hidden');
                
                const picksRes = await fetch(`https://fantasy.premierleague.com/api/entry/${teamId}/event/${bootstrapData.events.find(e => e.is_current).id}/picks/`);
                const picksData = await picksRes.json();
                
                itb = picksData.entry_history.bank / 10;
                myTeam = picksData.picks.map(pk => allPlayersById[pk.element]).filter(Boolean);
                
                updateStatus('Team loaded successfully!', 'success');
                setTimeout(() => goToStep(2), 800);
            } catch (e) {
                updateStatus('Failed to load team. Check your Team ID.', 'error');
            } finally {
                document.querySelector('.load-btn').disabled = false;
            }
        }
        
        // ===== RENDER STEP 2 (Combined Analyse + Select) =====
        function renderStep2() {
            const byPos = { 1: [], 2: [], 3: [], 4: [] };
            myTeam.forEach(p => byPos[p.pos].push(p));
            
            const posNames = { 1: 'Goalkeepers', 2: 'Defenders', 3: 'Midfielders', 4: 'Forwards' };
            
            let html = '<div class="formation-grid">';
            
            [1, 2, 3, 4].forEach(pos => {
                const players = byPos[pos];
                html += `
                    <div class="position-group">
                        <div class="position-header">
                            <span class="position-name">${posNames[pos]}</span>
                            <span class="position-count">${players.length} players</span>
                        </div>
                `;
                
                players.forEach(p => {
                    const xgi90 = p.minutes > 0 ? (p.xgi / p.minutes) * 90 : 0;
                    const ppg = p.price > 0 ? p.totalPts / p.price : 0;
                    const fdrColor = p.avgFDR <= 2.5 ? 'var(--accent-green)' : p.avgFDR >= 3.5 ? 'var(--accent-red)' : 'var(--accent-yellow)';
                    
                    html += `
                        <div class="player-card ${toSell.has(p.id) ? 'selected' : ''}" onclick="toggleSell(${p.id})">
                            <div class="player-header">
                                <div>
                                    <div class="player-name">${p.name}</div>
                                    <div class="player-team">${p.teamName} ‚Ä¢ ${p.own.toFixed(1)}%</div>
                                </div>
                                <div class="player-price">¬£${p.price.toFixed(1)}m</div>
                            </div>
                            <div class="player-stats">
                                <div class="stat">
                                    <div class="stat-value">${p.form.toFixed(1)}</div>
                                    <div class="stat-label">Form</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">${xgi90.toFixed(2)}</div>
                                    <div class="stat-label">xGI/90</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">${ppg.toFixed(1)}</div>
                                    <div class="stat-label">Pts/¬£m</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value" style="color: ${fdrColor};">${p.avgFDR.toFixed(1)}</div>
                                    <div class="stat-label">FDR</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            document.getElementById('step2Content').innerHTML = html;
        }
        
        function toggleSell(id) {
            if (toSell.has(id)) {
                toSell.delete(id);
            } else {
                toSell.add(id);
            }
            
            toSellPlayers = Array.from(toSell).map(id => allPlayersById[id]);
            toBuy = [];
            toBuyIds.clear();
            
            renderStep2();
            document.getElementById('toStep3Btn').disabled = toSell.size === 0;
        }
        
        // ===== RENDER STEP 3 (Browse Market) =====
        function updatePriceLabel() {
            const val = document.getElementById('priceFilter').value;
            document.getElementById('priceValue').textContent = `¬£${parseFloat(val).toFixed(1)}m`;
        }
        
        function updateBudgets() {
            const sellVal = toSellPlayers.reduce((s, p) => s + p.price, 0);
            const totalBudget = itb + sellVal;
            const spending = toBuy.reduce((s, p) => s + p.price, 0);
            const remaining = totalBudget - spending;
            
            document.getElementById('budgetDisplay').innerHTML = `
                <div class="budget-item">
                    <div class="budget-value">¬£${itb.toFixed(1)}m</div>
                    <div class="budget-label">In The Bank</div>
                </div>
                <div class="budget-item">
                    <div class="budget-value">¬£${sellVal.toFixed(1)}m</div>
                    <div class="budget-label">From Sales</div>
                </div>
                <div class="budget-item">
                    <div class="budget-value">¬£${totalBudget.toFixed(1)}m</div>
                    <div class="budget-label">Total Budget</div>
                </div>
                <div class="budget-item">
                    <div class="budget-value">¬£${spending.toFixed(1)}m</div>
                    <div class="budget-label">Spending</div>
                </div>
                <div class="budget-item">
                    <div class="budget-value" style="color: ${remaining < 0 ? 'var(--accent-red)' : 'var(--accent-green)'};">¬£${remaining.toFixed(1)}m</div>
                    <div class="budget-label">Remaining</div>
                </div>
            `;
        }
        
        function renderReplacements() {
            const posVal = document.getElementById('posFilter').value;
            const priceVal = parseFloat(document.getElementById('priceFilter').value);
            const sortVal = document.getElementById('sortFilter').value;
            
            const myTeamIds = new Set(myTeam.map(p => p.id));
            
            let filtered = allPlayers.filter(p => {
                if (myTeamIds.has(p.id)) return false;
                if (posVal && p.pos !== parseInt(posVal)) return false;
                if (p.price > priceVal) return false;
                
                // Team filter - only filter if not all teams selected
                if (!allTeamsSelected && selectedTeams.size > 0) {
                    // Check if player's team is in any of the selected teams' fixtures
                    const hasRelevantFixtures = p.fixtures.some(fx => {
                        const oppTeam = bootstrapData.teams.find(t => t.short_name === fx.opp);
                        return oppTeam && selectedTeams.has(oppTeam.id);
                    });
                    if (!hasRelevantFixtures) return false;
                }
                
                return true;
            });
            
            // Sort
            if (sortVal === 'form') filtered.sort((a, b) => b.form - a.form);
            else if (sortVal === 'xgi') filtered.sort((a, b) => {
                const aXgi = a.minutes > 0 ? (a.xgi / a.minutes) * 90 : 0;
                const bXgi = b.minutes > 0 ? (b.xgi / b.minutes) * 90 : 0;
                return bXgi - aXgi;
            });
            else if (sortVal === 'fdr') filtered.sort((a, b) => a.avgFDR - b.avgFDR);
            else if (sortVal === 'own') filtered.sort((a, b) => b.own - a.own);
            else if (sortVal === 'ppg') filtered.sort((a, b) => {
                const aPpg = a.price > 0 ? a.totalPts / a.price : 0;
                const bPpg = b.price > 0 ? b.totalPts / b.price : 0;
                return bPpg - aPpg;
            });
            
            filtered = filtered.slice(0, 50);
            
            let html = '';
            filtered.forEach(p => {
                const xgi90 = p.minutes > 0 ? (p.xgi / p.minutes) * 90 : 0;
                const ppg = p.price > 0 ? p.totalPts / p.price : 0;
                const fdrColor = p.avgFDR <= 2.5 ? 'var(--accent-green)' : p.avgFDR >= 3.5 ? 'var(--accent-red)' : 'var(--accent-yellow)';
                
                const fxHtml = p.fixtures.map(f => {
                    const cls = `fixture-badge fdr-${f.fdr}`;
                    return `<span class="${cls}">${f.isHome ? '' : '@'}${f.opp}</span>`;
                }).join('');
                
                html += `
                    <div class="market-player-card ${toBuyIds.has(p.id) ? 'selected' : ''}" onclick="toggleBuy(${p.id})">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div class="player-info">
                                <h4>${p.name}</h4>
                                <span class="player-meta">${p.teamName} ‚Ä¢ ${p.posName} ‚Ä¢ ${p.own.toFixed(1)}%</span>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-family: 'Space Mono'; font-size: 20px; font-weight: 700; color: var(--accent-green);">¬£${p.price.toFixed(1)}m</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 12px; background: var(--bg); border-radius: 8px; margin: 10px 0;">
                            <div style="text-align: center;">
                                <div style="font-family: 'Space Mono'; font-size: 14px; font-weight: 600; color: var(--accent-green);">${p.form.toFixed(1)}</div>
                                <div style="font-size: 8px; color: var(--text-dim); text-transform: uppercase;">Form</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-family: 'Space Mono'; font-size: 14px; font-weight: 600; color: var(--accent-green);">${xgi90.toFixed(2)}</div>
                                <div style="font-size: 8px; color: var(--text-dim); text-transform: uppercase;">xGI/90</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-family: 'Space Mono'; font-size: 14px; font-weight: 600;">${ppg.toFixed(1)}</div>
                                <div style="font-size: 8px; color: var(--text-dim); text-transform: uppercase;">Pts/¬£m</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-family: 'Space Mono'; font-size: 14px; font-weight: 600; color: ${fdrColor};">${p.avgFDR.toFixed(1)}</div>
                                <div style="font-size: 8px; color: var(--text-dim); text-transform: uppercase;">FDR</div>
                            </div>
                        </div>
                        <div class="fixture-badges">${fxHtml}</div>
                    </div>
                `;
            });
            
            if (!html) html = '<div class="empty-state" style="grid-column: 1/-1;"><div class="empty-state-icon">üîç</div><h3>No Players Found</h3><p>Try adjusting filters</p></div>';
            
            document.getElementById('step4Content').innerHTML = html;
            updateBudgets();
        }
        
        function toggleBuy(id) {
            const p = allPlayersById[id];
            
            if (toBuyIds.has(id)) {
                toBuyIds.delete(id);
                toBuy = toBuy.filter(x => x.id !== id);
            } else {
                const sellVal = toSellPlayers.reduce((s, p) => s + p.price, 0);
                const totalBudget = itb + sellVal;
                const spending = toBuy.reduce((s, p) => s + p.price, 0);
                
                // Fix budget check with rounding to 1 decimal place to avoid floating point issues
                const spendingAfter = Math.round((spending + p.price) * 10) / 10;
                const budgetRounded = Math.round(totalBudget * 10) / 10;
                
                if (spendingAfter > budgetRounded) {
                    alert(`Not enough budget! You need ¬£${(spendingAfter - budgetRounded).toFixed(1)}m more.`);
                    return;
                }
                
                if (toBuy.length >= toSell.size) {
                    alert(`You can only bring in ${toSell.size} player(s)`);
                    return;
                }
                
                toBuyIds.add(id);
                toBuy.push(p);
            }
            
            updateBudgets();
            renderReplacements();
            document.getElementById('toStep5Btn').disabled = toBuy.length !== toSell.size;
        }
        
        // ===== RENDER STEP 4 (Review) =====
        function renderStep5() {
            const sellVal = toSellPlayers.reduce((s, p) => s + p.price, 0);
            const buyVal = toBuy.reduce((s, p) => s + p.price, 0);
            const net = buyVal - sellVal;
            
            const avgSellFDR = toSellPlayers.reduce((s, p) => s + p.avgFDR, 0) / toSellPlayers.length;
            const avgBuyFDR = toBuy.reduce((s, p) => s + p.avgFDR, 0) / toBuy.length;
            const fdrDiff = avgSellFDR - avgBuyFDR;
            
            const avgSellForm = toSellPlayers.reduce((s, p) => s + p.form, 0) / toSellPlayers.length;
            const avgBuyForm = toBuy.reduce((s, p) => s + p.form, 0) / toBuy.length;
            const formDiff = avgBuyForm - avgSellForm;
            
            const avgSellXGI = toSellPlayers.reduce((s, p) => s + (p.minutes > 0 ? (p.xgi / p.minutes) * 90 : 0), 0) / toSellPlayers.length;
            const avgBuyXGI = toBuy.reduce((s, p) => s + (p.minutes > 0 ? (p.xgi / p.minutes) * 90 : 0), 0) / toBuy.length;
            const xgiDiff = avgBuyXGI - avgSellXGI;
            
            let html = `<div class="summary-box"><div class="summary-title">üìã Transfer Summary</div>`;
            
            for (let i = 0; i < toSellPlayers.length; i++) {
                const out = toSellPlayers[i];
                const inp = toBuy[i];
                html += `
                    <div class="transfer-row">
                        <div class="transfer-out">
                            <div class="transfer-player-name">${out.name}</div>
                            <div class="transfer-player-team">${out.teamName} ‚Ä¢ ${out.posName}</div>
                            <div class="transfer-player-price out">-¬£${out.price.toFixed(1)}m</div>
                        </div>
                        <div class="transfer-arrow">‚Üí</div>
                        <div class="transfer-in">
                            <div class="transfer-player-name">${inp.name}</div>
                            <div class="transfer-player-team">${inp.teamName} ‚Ä¢ ${inp.posName}</div>
                            <div class="transfer-player-price in">+¬£${inp.price.toFixed(1)}m</div>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            
            const hit = toSellPlayers.length > 1 ? (toSellPlayers.length - 1) * -4 : 0;
            
            html += `
                <div class="summary-box">
                    <div class="summary-title">üìä Key Metrics Comparison</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" style="color: ${net <= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                ${net <= 0 ? '+' : '-'}¬£${Math.abs(net).toFixed(1)}m
                            </div>
                            <div class="stat-label">${net <= 0 ? 'Budget Saved' : 'Extra Spent'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" style="color: ${fdrDiff > 0 ? 'var(--accent-green)' : fdrDiff < 0 ? 'var(--accent-red)' : 'var(--accent-yellow)'};">
                                ${fdrDiff > 0 ? '+' : ''}${fdrDiff.toFixed(2)}
                            </div>
                            <div class="stat-label">FDR Change (Lower = Better)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" style="color: ${formDiff > 0 ? 'var(--accent-green)' : formDiff < 0 ? 'var(--accent-red)' : 'var(--accent-yellow)'};">
                                ${formDiff > 0 ? '+' : ''}${formDiff.toFixed(2)}
                            </div>
                            <div class="stat-label">Form Change</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" style="color: ${xgiDiff > 0 ? 'var(--accent-green)' : xgiDiff < 0 ? 'var(--accent-red)' : 'var(--accent-yellow)'};">
                                ${xgiDiff > 0 ? '+' : ''}${xgiDiff.toFixed(2)}
                            </div>
                            <div class="stat-label">xGI/90 Change</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" style="color: ${hit < 0 ? 'var(--accent-red)' : 'var(--accent-green)'};">${hit}</div>
                            <div class="stat-label">Points Hit</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add detailed player stats comparison
            html += `
                <div class="summary-box">
                    <div class="summary-title">üë• Detailed Player Comparison</div>
            `;
            
            for (let i = 0; i < toSellPlayers.length; i++) {
                const out = toSellPlayers[i];
                const inp = toBuy[i];
                
                const outXGI = out.minutes > 0 ? (out.xgi / out.minutes) * 90 : 0;
                const inXGI = inp.minutes > 0 ? (inp.xgi / inp.minutes) * 90 : 0;
                const outPPG = out.price > 0 ? out.totalPts / out.price : 0;
                const inPPG = inp.price > 0 ? inp.totalPts / inp.price : 0;
                
                html += `
                    <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
                        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">${out.name}</div>
                                <div style="font-size: 11px; color: var(--text-dim);">${out.teamName} ‚Ä¢ ${out.posName}</div>
                            </div>
                            <div style="align-self: center; color: var(--accent-blue);">‚Üí</div>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">${inp.name}</div>
                                <div style="font-size: 11px; color: var(--text-dim);">${inp.teamName} ‚Ä¢ ${inp.posName}</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; text-align: center; font-size: 12px;">
                            <div>
                                <div style="color: var(--text-dim); margin-bottom: 4px;">Form</div>
                                <div>${out.form.toFixed(1)} ‚Üí ${inp.form.toFixed(1)}</div>
                                <div style="font-size: 10px; color: ${inp.form > out.form ? 'var(--accent-green)' : inp.form < out.form ? 'var(--accent-red)' : 'var(--text-dim)'};">
                                    ${inp.form > out.form ? '‚Üë' : inp.form < out.form ? '‚Üì' : '='} ${(inp.form - out.form).toFixed(1)}
                                </div>
                            </div>
                            <div>
                                <div style="color: var(--text-dim); margin-bottom: 4px;">xGI/90</div>
                                <div>${outXGI.toFixed(2)} ‚Üí ${inXGI.toFixed(2)}</div>
                                <div style="font-size: 10px; color: ${inXGI > outXGI ? 'var(--accent-green)' : inXGI < outXGI ? 'var(--accent-red)' : 'var(--text-dim)'};">
                                    ${inXGI > outXGI ? '‚Üë' : inXGI < outXGI ? '‚Üì' : '='} ${(inXGI - outXGI).toFixed(2)}
                                </div>
                            </div>
                            <div>
                                <div style="color: var(--text-dim); margin-bottom: 4px;">Pts/¬£m</div>
                                <div>${outPPG.toFixed(1)} ‚Üí ${inPPG.toFixed(1)}</div>
                                <div style="font-size: 10px; color: ${inPPG > outPPG ? 'var(--accent-green)' : inPPG < outPPG ? 'var(--accent-red)' : 'var(--text-dim)'};">
                                    ${inPPG > outPPG ? '‚Üë' : inPPG < outPPG ? '‚Üì' : '='} ${(inPPG - outPPG).toFixed(1)}
                                </div>
                            </div>
                            <div>
                                <div style="color: var(--text-dim); margin-bottom: 4px;">FDR</div>
                                <div>${out.avgFDR.toFixed(1)} ‚Üí ${inp.avgFDR.toFixed(1)}</div>
                                <div style="font-size: 10px; color: ${inp.avgFDR < out.avgFDR ? 'var(--accent-green)' : inp.avgFDR > out.avgFDR ? 'var(--accent-red)' : 'var(--text-dim)'};">
                                    ${inp.avgFDR < out.avgFDR ? '‚Üì' : inp.avgFDR > out.avgFDR ? '‚Üë' : '='} ${(inp.avgFDR - out.avgFDR).toFixed(1)}
                                </div>
                            </div>
                            <div>
                                <div style="color: var(--text-dim); margin-bottom: 4px;">Price</div>
                                <div>¬£${out.price.toFixed(1)}m ‚Üí ¬£${inp.price.toFixed(1)}m</div>
                                <div style="font-size: 10px; color: ${inp.price < out.price ? 'var(--accent-green)' : inp.price > out.price ? 'var(--accent-red)' : 'var(--text-dim)'};">
                                    ${inp.price < out.price ? '‚Üì' : inp.price > out.price ? '‚Üë' : '='} ¬£${Math.abs(inp.price - out.price).toFixed(1)}m
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            
            // Add info box with guidance
            html += `
                <div class="info-box">
                    <h4>üí° Review Your Transfer</h4>
                    <p>Consider these factors when making your decision:</p>
                    <ul>
                        <li><strong>FDR (Fixture Difficulty):</strong> Lower is better. A positive FDR change means easier upcoming fixtures.</li>
                        <li><strong>Form:</strong> Recent performance trend. Higher is better.</li>
                        <li><strong>xGI/90:</strong> Expected goal involvements per 90 minutes. Indicates attacking threat.</li>
                        <li><strong>Pts/¬£m:</strong> Points per million spent. Indicates value for money.</li>
                        <li><strong>Points Hit:</strong> ${hit === 0 ? 'Free transfer - no penalty!' : `You'll take a ${Math.abs(hit)} point hit for ${toSellPlayers.length - 1} extra transfer(s).`}</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('step5Content').innerHTML = html;
        }
        
        function executePlan() {
            localStorage.setItem('fpl_transfer_plan', JSON.stringify({
                date: new Date().toISOString(),
                out: toSellPlayers.map(p => ({ id: p.id, name: p.name })),
                in: toBuy.map(p => ({ id: p.id, name: p.name }))
            }));
            alert('Plan saved! Opening FPL...');
            window.open('https://fantasy.premierleague.com/transfers', '_blank');
        }
        
        // ===== NAVIGATION =====
        function goToStep(step) {
            if (step >= 2 && myTeam.length !== 15) { alert('Load your team first!'); return; }
            if (step >= 3 && toSell.size === 0) { alert('Select players to sell first!'); return; }
            if (step === 4 && toBuy.length !== toSell.size) { alert('Select all replacements first!'); return; }
            
            document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`panel-${step}`).classList.add('active');
            
            updateProgress(step);
            
            if (step === 2) renderStep2();
            else if (step === 3) {
                if (toSellPlayers.length === 1) document.getElementById('posFilter').value = toSellPlayers[0].pos;
                // Initialize team filter to all teams when entering step 3
                allTeamsSelected = true;
                selectedTeams.clear();
                bootstrapData.teams.forEach(t => selectedTeams.add(t.id));
                initializeTeamFilter();
                updateTeamFilterDisplay();
                renderReplacements();
            }
            else if (step === 4) renderStep5();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function updateProgress(current) {
            document.querySelectorAll('.progress-step').forEach((el, i) => {
                el.classList.remove('active', 'completed', 'disabled');
                if (i + 1 < current) el.classList.add('completed');
                else if (i + 1 === current) el.classList.add('active');
                else if (i + 1 > current + 1) el.classList.add('disabled');
            });
        }
        
        function updateStatus(msg, type) {
            const bar = document.getElementById('statusBar');
            bar.style.display = 'flex';
            bar.className = `status-bar ${type}`;
            bar.innerHTML = type === 'loading' ? `<div class="spinner"></div><span>${msg}</span>` : `<span>${type === 'success' ? '‚úì' : '‚ö†'} ${msg}</span>`;
        }
        
        // Enter key to load
        document.getElementById('teamIdInput').addEventListener('keypress', e => { if (e.key === 'Enter') loadTeamById(); });
        
        window.addEventListener('load', init);
    </script>
</body>
</html>
