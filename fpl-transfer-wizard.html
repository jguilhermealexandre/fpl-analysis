<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPL Transfer Wizard</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Space+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #0a0e14;
            --surface: #151920;
            --surface-light: #1d242e;
            --accent-green: #00ff88;
            --accent-red: #ff4757;
            --accent-yellow: #ffa502;
            --accent-blue: #00ccff;
            --accent-purple: #9b59b6;
            --text: #e0e5ed;
            --text-dim: #8b95a5;
            --border: #2a3340;
        }
        
        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'DM Mono', monospace;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--surface) 0%, var(--surface-light) 100%);
            border-bottom: 2px solid var(--accent-purple);
            padding: 20px 30px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-family: 'Space Mono', monospace;
            font-size: 24px;
            color: var(--accent-green);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .home-link {
            color: var(--text-dim);
            text-decoration: none;
            font-size: 12px;
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .home-link:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        
        /* Progress Bar */
        .progress-container {
            background: var(--surface);
            padding: 20px 30px;
            border-bottom: 1px solid var(--border);
        }
        
        .progress-inner {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .wizard-progress {
            display: flex;
            justify-content: space-between;
            position: relative;
        }
        
        .wizard-progress::before {
            content: '';
            position: absolute;
            top: 22px;
            left: 60px;
            right: 60px;
            height: 3px;
            background: var(--border);
        }
        
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .progress-step:hover .progress-icon {
            transform: scale(1.1);
        }
        
        .progress-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg);
            border: 3px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .progress-step.active .progress-icon {
            border-color: var(--accent-green);
            background: var(--accent-green);
            color: var(--bg);
        }
        
        .progress-step.completed .progress-icon {
            border-color: var(--accent-green);
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
        }
        
        .progress-step.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .progress-label {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .progress-step.active .progress-label,
        .progress-step.completed .progress-label {
            color: var(--accent-green);
        }
        
        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }
        
        /* Step Panels */
        .step-panel {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        
        .step-panel.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .panel-header {
            margin-bottom: 25px;
        }
        
        .panel-header h2 {
            font-family: 'Space Mono', monospace;
            font-size: 24px;
            color: var(--accent-green);
            margin-bottom: 8px;
        }
        
        .panel-header p {
            font-size: 13px;
            color: var(--text-dim);
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-green) 0%, #00cc70 100%);
            color: var(--bg);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }
        
        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 2px solid var(--border);
        }
        
        .btn-secondary:hover:not(:disabled) {
            border-color: var(--accent-blue);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Status Bar */
        .status-bar {
            padding: 12px 20px;
            background: var(--surface);
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
        }
        
        .status-bar.loading {
            border-left: 4px solid var(--accent-yellow);
        }
        
        .status-bar.success {
            border-left: 4px solid var(--accent-green);
        }
        
        .status-bar.error {
            border-left: 4px solid var(--accent-red);
        }
        
        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Player Cards */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .player-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .player-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }
        
        .player-card.sell-selected {
            border-color: var(--accent-red);
            background: rgba(255, 71, 87, 0.1);
        }
        
        .player-card.selected {
            border-color: var(--accent-green);
            background: rgba(0, 255, 136, 0.1);
        }
        
        .player-card.urgent {
            border-color: var(--accent-red);
        }
        
        .player-card.consider {
            border-color: var(--accent-yellow);
        }
        
        .player-card.hold {
            border-color: var(--accent-green);
        }
        
        .player-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .player-info h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .player-meta {
            font-size: 11px;
            color: var(--text-dim);
        }
        
        .player-rating {
            text-align: right;
        }
        
        .rating-value {
            font-family: 'Space Mono', monospace;
            font-size: 26px;
            font-weight: 700;
            line-height: 1;
        }
        
        .rating-value.urgent { color: var(--accent-red); }
        .rating-value.consider { color: var(--accent-yellow); }
        .rating-value.hold { color: var(--accent-green); }
        
        .rating-label {
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            padding: 3px 8px;
            border-radius: 4px;
            margin-top: 4px;
            display: inline-block;
        }
        
        .rating-label.urgent { background: var(--accent-red); color: white; }
        .rating-label.consider { background: var(--accent-yellow); color: var(--bg); }
        .rating-label.hold { background: var(--accent-green); color: var(--bg); }
        
        .player-issues {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }
        
        .issue-tag {
            font-size: 9px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .issue-tag.critical { background: rgba(255, 71, 87, 0.2); color: var(--accent-red); }
        .issue-tag.warning { background: rgba(255, 165, 2, 0.2); color: var(--accent-yellow); }
        .issue-tag.positive { background: rgba(0, 255, 136, 0.2); color: var(--accent-green); }
        .issue-tag.info { background: rgba(0, 204, 255, 0.2); color: var(--accent-blue); }
        
        /* Team Cards */
        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .team-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .team-card:hover {
            border-color: var(--accent-blue);
        }
        
        .team-card.selected {
            border-color: var(--accent-green);
            background: rgba(0, 255, 136, 0.1);
        }
        
        .team-name {
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--accent-blue);
        }
        
        .team-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .team-stat {
            text-align: center;
            padding: 8px;
            background: var(--bg);
            border-radius: 6px;
        }
        
        .team-stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 18px;
            font-weight: 600;
        }
        
        .team-stat-label {
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        .team-fixtures {
            display: flex;
            gap: 5px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        
        .fixture-badge {
            font-size: 9px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .fixture-badge.fdr-1, .fixture-badge.fdr-2 { background: rgba(0, 255, 136, 0.2); color: var(--accent-green); }
        .fixture-badge.fdr-3 { background: rgba(255, 165, 2, 0.2); color: var(--accent-yellow); }
        .fixture-badge.fdr-4, .fixture-badge.fdr-5 { background: rgba(255, 71, 87, 0.2); color: var(--accent-red); }
        
        /* Replacement Cards */
        .replacement-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .replacement-card:hover {
            border-color: var(--accent-green);
        }
        
        .replacement-card.selected {
            border-color: var(--accent-green);
            background: rgba(0, 255, 136, 0.1);
        }
        
        .replacement-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .replacement-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .replacement-meta {
            font-size: 11px;
            color: var(--text-dim);
        }
        
        .replacement-price {
            font-family: 'Space Mono', monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-green);
        }
        
        .replacement-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 12px;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .rep-stat {
            text-align: center;
        }
        
        .rep-stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-green);
        }
        
        .rep-stat-label {
            font-size: 8px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        /* Summary Box */
        .summary-box {
            background: var(--surface);
            border: 2px solid var(--accent-green);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .summary-title {
            font-family: 'Space Mono', monospace;
            font-size: 18px;
            color: var(--accent-green);
            margin-bottom: 20px;
        }
        
        .transfer-row {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .transfer-out, .transfer-in {
            flex: 1;
        }
        
        .transfer-out { text-align: right; }
        
        .transfer-arrow {
            font-size: 24px;
            color: var(--accent-green);
        }
        
        .transfer-player-name {
            font-weight: 600;
            font-size: 15px;
        }
        
        .transfer-player-team {
            font-size: 11px;
            color: var(--text-dim);
        }
        
        .transfer-player-price {
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            margin-top: 4px;
        }
        
        .transfer-player-price.out { color: var(--accent-red); }
        .transfer-player-price.in { color: var(--accent-green); }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: var(--surface);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        /* Navigation */
        .wizard-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        
        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--surface);
            border-radius: 10px;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        .filter-select {
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'DM Mono', monospace;
            font-size: 11px;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: var(--accent-green);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .empty-state h3 {
            font-size: 18px;
            color: var(--text);
            margin-bottom: 10px;
        }
        
        /* Budget Display */
        .budget-display {
            background: var(--surface);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        
        .budget-item {
            padding: 0 20px;
        }
        
        .budget-value {
            font-family: 'Space Mono', monospace;
            font-size: 24px;
            font-weight: 700;
        }
        
        .budget-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-top: 4px;
        }
        
        /* Success Box */
        .success-box {
            background: rgba(0, 255, 136, 0.1);
            border: 2px solid var(--accent-green);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .success-box h4 {
            color: var(--accent-green);
            margin-bottom: 8px;
        }
        
        .success-box p {
            font-size: 12px;
            color: var(--text-dim);
        }
        
        /* Scrollable container */
        .scroll-container {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .scroll-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .scroll-container::-webkit-scrollbar-track {
            background: var(--bg);
        }
        
        .scroll-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .wizard-progress::before {
                display: none;
            }
            
            .progress-label {
                display: none;
            }
            
            .players-grid {
                grid-template-columns: 1fr;
            }
            
            .transfer-row {
                flex-direction: column;
                text-align: center;
            }
            
            .transfer-out, .transfer-in {
                text-align: center;
            }
            
            .transfer-arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1>üßô‚Äç‚ôÇÔ∏è Transfer Wizard</h1>
            <div class="header-actions">
                <a href="index.html" class="home-link">‚Üê Back to Tools</a>
            </div>
        </div>
    </header>
    
    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="progress-inner">
            <div class="wizard-progress">
                <div class="progress-step active" data-step="1" onclick="goToStep(1)">
                    <div class="progress-icon">üìä</div>
                    <span class="progress-label">Analyze</span>
                </div>
                <div class="progress-step disabled" data-step="2" onclick="goToStep(2)">
                    <div class="progress-icon">üéØ</div>
                    <span class="progress-label">Select</span>
                </div>
                <div class="progress-step disabled" data-step="3" onclick="goToStep(3)">
                    <div class="progress-icon">üìÖ</div>
                    <span class="progress-label">Fixtures</span>
                </div>
                <div class="progress-step disabled" data-step="4" onclick="goToStep(4)">
                    <div class="progress-icon">üë§</div>
                    <span class="progress-label">Replace</span>
                </div>
                <div class="progress-step disabled" data-step="5" onclick="goToStep(5)">
                    <div class="progress-icon">‚úÖ</div>
                    <span class="progress-label">Review</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Status Bar -->
        <div id="statusBar" class="status-bar loading">
            <div class="spinner"></div>
            <span id="statusText">Loading FPL data...</span>
        </div>
        
        <!-- Step 1: Analyze Team -->
        <div class="step-panel active" id="panel-1">
            <div class="panel-header">
                <h2>Step 1: Analyze Your Squad</h2>
                <p>Your players are analyzed and sorted by sell priority. Red = urgent sell, Yellow = consider, Green = hold.</p>
            </div>
            
            <div id="teamAnalysis">
                <div class="empty-state">
                    <div class="empty-state-icon">‚öΩ</div>
                    <h3>No Team Found</h3>
                    <p>Build your team in "My Team Analysis" first, then return here.</p>
                    <button class="btn btn-primary" onclick="window.location.href='fpl-my-team-analysis.html'" style="margin-top: 20px;">
                        Build My Team ‚Üí
                    </button>
                </div>
            </div>
            
            <div class="wizard-nav" id="nav-1" style="display: none;">
                <div></div>
                <button class="btn btn-primary" onclick="goToStep(2)">Continue to Selection ‚Üí</button>
            </div>
        </div>
        
        <!-- Step 2: Select Players to Sell -->
        <div class="step-panel" id="panel-2">
            <div class="panel-header">
                <h2>Step 2: Select Players to Sell</h2>
                <p>Click on players you want to transfer out. Your budget will update automatically.</p>
            </div>
            
            <div class="budget-display" id="budgetDisplay">
                <div class="budget-item">
                    <div class="budget-value" style="color: var(--accent-green);" id="itbValue">¬£0.0m</div>
                    <div class="budget-label">In The Bank</div>
                </div>
                <div class="budget-item">
                    <div class="budget-value" style="color: var(--accent-yellow);" id="sellingValue">¬£0.0m</div>
                    <div class="budget-label">Selling Value</div>
                </div>
                <div class="budget-item">
                    <div class="budget-value" style="color: var(--accent-green);" id="totalBudget">¬£0.0m</div>
                    <div class="budget-label">Total Available</div>
                </div>
                <div class="budget-item">
                    <div class="budget-value" id="transferCount">0</div>
                    <div class="budget-label">Transfers Out</div>
                </div>
            </div>
            
            <div id="sellSelection" class="players-grid"></div>
            
            <div class="wizard-nav">
                <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button>
                <button class="btn btn-primary" id="toFixturesBtn" onclick="goToStep(3)" disabled>View Fixture Swings ‚Üí</button>
            </div>
        </div>
        
        <!-- Step 3: Fixture Analysis -->
        <div class="step-panel" id="panel-3">
            <div class="panel-header">
                <h2>Step 3: Explore Fixture Opportunities</h2>
                <p>Teams with favorable upcoming fixtures. Target replacements from these teams.</p>
            </div>
            
            <div id="fixtureAnalysis" class="teams-grid"></div>
            
            <div class="wizard-nav">
                <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Back</button>
                <button class="btn btn-primary" onclick="goToStep(4)">Find Replacements ‚Üí</button>
            </div>
        </div>
        
        <!-- Step 4: Find Replacements -->
        <div class="step-panel" id="panel-4">
            <div class="panel-header">
                <h2>Step 4: Choose Replacements</h2>
                <p id="replacementHeader">Select players to bring in. Filtered by position and budget.</p>
            </div>
            
            <div class="filter-bar">
                <div class="filter-group">
                    <span class="filter-label">Position:</span>
                    <select id="positionFilter" class="filter-select" onchange="filterReplacements()">
                        <option value="all">All Positions</option>
                        <option value="1">Goalkeepers</option>
                        <option value="2">Defenders</option>
                        <option value="3">Midfielders</option>
                        <option value="4">Forwards</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Max Price:</span>
                    <select id="priceFilter" class="filter-select" onchange="filterReplacements()">
                        <option value="99">Any Price</option>
                        <option value="5.0">Under ¬£5.0m</option>
                        <option value="6.0">Under ¬£6.0m</option>
                        <option value="7.0">Under ¬£7.0m</option>
                        <option value="8.0">Under ¬£8.0m</option>
                        <option value="10.0">Under ¬£10.0m</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Sort By:</span>
                    <select id="sortFilter" class="filter-select" onchange="filterReplacements()">
                        <option value="score">Recommendation Score</option>
                        <option value="form">Form</option>
                        <option value="xgi">xGI per 90</option>
                        <option value="price">Price (Low to High)</option>
                        <option value="fixtures">Fixtures (Easiest)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Team:</span>
                    <select id="teamFilter" class="filter-select" onchange="filterReplacements()">
                        <option value="all">All Teams</option>
                    </select>
                </div>
            </div>
            
            <div class="budget-display">
                <div class="budget-item">
                    <div class="budget-value" style="color: var(--accent-green);" id="availableBudget">¬£0.0m</div>
                    <div class="budget-label">Available</div>
                </div>
                <div class="budget-item">
                    <div class="budget-value" style="color: var(--accent-yellow);" id="spendingValue">¬£0.0m</div>
                    <div class="budget-label">Spending</div>
                </div>
                <div class="budget-item">
                    <div class="budget-value" id="remainingBudget">¬£0.0m</div>
                    <div class="budget-label">Remaining</div>
                </div>
                <div class="budget-item">
                    <div class="budget-value" id="inCount">0</div>
                    <div class="budget-label">Transfers In</div>
                </div>
            </div>
            
            <div id="replacementOptions" class="scroll-container players-grid"></div>
            
            <div class="wizard-nav">
                <button class="btn btn-secondary" onclick="goToStep(3)">‚Üê Back</button>
                <button class="btn btn-primary" id="toReviewBtn" onclick="goToStep(5)" disabled>Review Transfer Plan ‚Üí</button>
            </div>
        </div>
        
        <!-- Step 5: Review -->
        <div class="step-panel" id="panel-5">
            <div class="panel-header">
                <h2>Step 5: Review Your Transfer Plan</h2>
                <p>Confirm your transfers before heading to the official FPL site.</p>
            </div>
            
            <div id="transferSummary"></div>
            
            <div class="wizard-nav">
                <button class="btn btn-secondary" onclick="goToStep(4)">‚Üê Back</button>
                <button class="btn btn-primary" onclick="executeTransfers()">Save Plan & Go to FPL ‚Üí</button>
            </div>
        </div>
    </main>
    
    <script>
        // =====================================================
        // STATE MANAGEMENT
        // =====================================================
        let currentStep = 1;
        let allPlayers = [];
        let myTeam = [];
        let analyzedTeam = [];
        let playersToSell = [];
        let playersToSellDetails = [];
        let playersToSellIds = new Set();
        let playersToBuy = [];
        let playersToBuyIds = new Set();
        let teams = {};
        let teamFixtures = {};
        let teamAnalysisData = [];
        let itb = 0.5; // Default in-the-bank
        let freeTransfers = 1;
        
        const POSITION_NAMES = { 1: 'GK', 2: 'DEF', 3: 'MID', 4: 'FWD' };
        const CORS_PROXY = 'https://corsproxy.io/?';
        
        // =====================================================
        // INITIALIZATION
        // =====================================================
        async function init() {
            try {
                updateStatus('Loading FPL data...', 'loading');
                
                // Load bootstrap data
                const bootstrapUrl = 'https://fantasy.premierleague.com/api/bootstrap-static/';
                const bootstrapRes = await fetch(CORS_PROXY + encodeURIComponent(bootstrapUrl));
                const bootstrapData = await bootstrapRes.json();
                
                // Build teams object
                teams = {};
                bootstrapData.teams.forEach(t => {
                    teams[t.id] = {
                        id: t.id,
                        name: t.name,
                        short_name: t.short_name,
                        strength: t.strength,
                        strength_attack_home: t.strength_attack_home,
                        strength_attack_away: t.strength_attack_away,
                        strength_defence_home: t.strength_defence_home,
                        strength_defence_away: t.strength_defence_away
                    };
                });
                
                // Load fixtures
                const fixturesUrl = 'https://fantasy.premierleague.com/api/fixtures/';
                const fixturesRes = await fetch(CORS_PROXY + encodeURIComponent(fixturesUrl));
                const fixturesData = await fixturesRes.json();
                
                // Organize fixtures by team
                const upcomingFixtures = fixturesData
                    .filter(f => !f.finished && f.event !== null)
                    .sort((a, b) => a.event - b.event);
                
                teamFixtures = {};
                Object.keys(teams).forEach(teamId => {
                    const tid = parseInt(teamId);
                    const teamFix = upcomingFixtures
                        .filter(f => f.team_h === tid || f.team_a === tid)
                        .slice(0, 5);
                    
                    teamFixtures[tid] = teamFix.map(f => ({
                        event: f.event,
                        opponent: f.team_h === tid ? f.team_a : f.team_h,
                        opponentName: f.team_h === tid ? teams[f.team_a]?.short_name : teams[f.team_h]?.short_name,
                        difficulty: f.team_h === tid ? f.team_h_difficulty : f.team_a_difficulty,
                        isHome: f.team_h === tid
                    }));
                });
                
                // Build all players
                allPlayers = bootstrapData.elements
                    .filter(p => p.minutes > 0)
                    .map(p => {
                        const playerFixtures = teamFixtures[p.team] || [];
                        const avgFDR = playerFixtures.length > 0 
                            ? playerFixtures.slice(0, 3).reduce((sum, f) => sum + f.difficulty, 0) / Math.min(3, playerFixtures.length)
                            : 3;
                        
                        return {
                            id: p.id,
                            name: p.web_name,
                            fullName: `${p.first_name} ${p.second_name}`,
                            team: teams[p.team]?.short_name || 'UNK',
                            teamId: p.team,
                            teamName: teams[p.team]?.name || 'Unknown',
                            position: p.element_type,
                            positionName: POSITION_NAMES[p.element_type],
                            price: p.now_cost / 10,
                            form: parseFloat(p.form) || 0,
                            ownership: parseFloat(p.selected_by_percent) || 0,
                            minutes: p.minutes,
                            totalPoints: p.total_points,
                            pointsPerGame: parseFloat(p.points_per_game) || 0,
                            status: p.status,
                            news: p.news || '',
                            chanceOfPlaying: p.chance_of_playing_next_round,
                            expectedGoals: parseFloat(p.expected_goals) || 0,
                            expectedAssists: parseFloat(p.expected_assists) || 0,
                            expectedGI: parseFloat(p.expected_goal_involvements) || 0,
                            goals: p.goals_scored,
                            assists: p.assists,
                            cleanSheets: p.clean_sheets,
                            bonus: p.bonus,
                            ictIndex: parseFloat(p.ict_index) || 0,
                            fixtures: playerFixtures,
                            avgFDR: avgFDR
                        };
                    });
                
                // Populate team filter
                const teamSelect = document.getElementById('teamFilter');
                Object.values(teams).sort((a, b) => a.name.localeCompare(b.name)).forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.id;
                    option.textContent = t.name;
                    teamSelect.appendChild(option);
                });
                
                updateStatus(`Loaded ${allPlayers.length} players and ${Object.keys(teams).length} teams`, 'success');
                
                // Load saved team
                loadSavedTeam();
                
                // Generate team analysis for fixture swing
                generateTeamAnalysis();
                
            } catch (error) {
                console.error('Init error:', error);
                updateStatus('Error loading data. Please refresh.', 'error');
            }
        }
        
        function loadSavedTeam() {
            const saved = localStorage.getItem('fpl_my_team');
            if (saved) {
                myTeam = JSON.parse(saved);
                if (myTeam.length === 15) {
                    analyzeTeam();
                }
            }
        }
        
        // =====================================================
        // TEAM ANALYSIS (Step 1)
        // =====================================================
        function analyzeTeam() {
            if (myTeam.length !== 15) {
                document.getElementById('teamAnalysis').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚öΩ</div>
                        <h3>Incomplete Team</h3>
                        <p>You have ${myTeam.length}/15 players. Build your complete team first.</p>
                        <button class="btn btn-primary" onclick="window.location.href='fpl-my-team-analysis.html'" style="margin-top: 20px;">
                            Build My Team ‚Üí
                        </button>
                    </div>
                `;
                return;
            }
            
            // Analyze each player
            analyzedTeam = myTeam.map(savedPlayer => {
                // Find full player data
                const fullPlayer = allPlayers.find(p => p.id === savedPlayer.id) || savedPlayer;
                
                // Calculate sell rating
                const analysis = calculateSellRating(fullPlayer);
                
                return {
                    ...fullPlayer,
                    ...analysis
                };
            });
            
            // Sort by sell rating (highest = most urgent to sell)
            analyzedTeam.sort((a, b) => b.sellRating - a.sellRating);
            
            renderAnalyzedTeam();
            document.getElementById('nav-1').style.display = 'flex';
        }
        
        function calculateSellRating(player) {
            let sellRating = 0;
            const issues = [];
            
            // Factor 1: Injury/Availability
            if (player.status === 'i' || player.status === 's') {
                sellRating += 50;
                issues.push({ text: 'üî¥ Injured/Suspended', type: 'critical' });
            } else if (player.status === 'd') {
                sellRating += 30;
                issues.push({ text: 'üü° Doubtful', type: 'warning' });
            }
            
            if (player.chanceOfPlaying !== null && player.chanceOfPlaying < 50) {
                sellRating += 25;
                issues.push({ text: `${player.chanceOfPlaying}% Chance`, type: 'critical' });
            }
            
            // Factor 2: Form
            if (player.form < 2.0) {
                sellRating += 35;
                issues.push({ text: 'Very Poor Form', type: 'critical' });
            } else if (player.form < 3.5) {
                sellRating += 20;
                issues.push({ text: 'Below Avg Form', type: 'warning' });
            } else if (player.form >= 6.0) {
                sellRating -= 25;
                issues.push({ text: 'Excellent Form', type: 'positive' });
            } else if (player.form >= 4.5) {
                sellRating -= 10;
                issues.push({ text: 'Good Form', type: 'positive' });
            }
            
            // Factor 3: xGI (for attackers)
            if (player.position >= 3) {
                const xGIPer90 = player.minutes > 0 ? (player.expectedGI / player.minutes) * 90 : 0;
                if (xGIPer90 < 0.25) {
                    sellRating += 25;
                    issues.push({ text: 'Low xGI', type: 'warning' });
                } else if (xGIPer90 >= 0.5) {
                    sellRating -= 15;
                    issues.push({ text: 'High xGI', type: 'positive' });
                }
            }
            
            // Factor 4: Fixtures
            if (player.avgFDR >= 4.0) {
                sellRating += 30;
                issues.push({ text: 'Hard Fixtures', type: 'critical' });
            } else if (player.avgFDR >= 3.5) {
                sellRating += 15;
                issues.push({ text: 'Tough Fixtures', type: 'warning' });
            } else if (player.avgFDR <= 2.5) {
                sellRating -= 20;
                issues.push({ text: 'Easy Fixtures', type: 'positive' });
            } else if (player.avgFDR <= 3.0) {
                sellRating -= 10;
                issues.push({ text: 'Good Fixtures', type: 'positive' });
            }
            
            // Factor 5: Ownership protection
            if (player.ownership >= 25) {
                sellRating -= 20;
                issues.push({ text: 'üõ°Ô∏è Template', type: 'info' });
            } else if (player.ownership < 5) {
                sellRating += 10;
                issues.push({ text: '‚öîÔ∏è Differential', type: 'info' });
            }
            
            // Determine priority
            let priority, action;
            if (sellRating >= 60) {
                priority = 'urgent';
                action = 'Urgent Sell';
            } else if (sellRating >= 35) {
                priority = 'consider';
                action = 'Consider Selling';
            } else {
                priority = 'hold';
                action = 'Hold';
            }
            
            return {
                sellRating: Math.max(0, Math.min(100, sellRating)),
                issues,
                priority,
                action
            };
        }
        
        function renderAnalyzedTeam() {
            const container = document.getElementById('teamAnalysis');
            
            const urgentCount = analyzedTeam.filter(p => p.priority === 'urgent').length;
            const considerCount = analyzedTeam.filter(p => p.priority === 'consider').length;
            
            let html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" style="color: var(--accent-red);">${urgentCount}</div>
                        <div class="stat-label">Urgent Sells</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: var(--accent-yellow);">${considerCount}</div>
                        <div class="stat-label">Consider</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: var(--accent-green);">${15 - urgentCount - considerCount}</div>
                        <div class="stat-label">Strong Holds</div>
                    </div>
                </div>
                <div class="players-grid">
            `;
            
            analyzedTeam.forEach(player => {
                const fixturesHtml = player.fixtures?.slice(0, 3).map(f => `
                    <span class="fixture-badge fdr-${f.difficulty}">${f.opponentName}(${f.isHome ? 'H' : 'A'})</span>
                `).join('') || '';
                
                html += `
                    <div class="player-card ${player.priority}">
                        <div class="player-top">
                            <div class="player-info">
                                <h4>${player.name}</h4>
                                <span class="player-meta">${player.team} ‚Ä¢ ${player.positionName} ‚Ä¢ ¬£${player.price.toFixed(1)}m</span>
                            </div>
                            <div class="player-rating">
                                <div class="rating-value ${player.priority}">${player.sellRating}</div>
                                <span class="rating-label ${player.priority}">${player.action}</span>
                            </div>
                        </div>
                        <div class="player-issues">
                            ${player.issues.map(i => `<span class="issue-tag ${i.type}">${i.text}</span>`).join('')}
                        </div>
                        <div class="team-fixtures" style="margin-top: 10px;">
                            ${fixturesHtml}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // =====================================================
        // SELL SELECTION (Step 2)
        // =====================================================
        function renderSellSelection() {
            const container = document.getElementById('sellSelection');
            
            let html = '';
            analyzedTeam.forEach(player => {
                const isSelected = playersToSellIds.has(player.id);
                
                html += `
                    <div class="player-card ${isSelected ? 'sell-selected' : ''} ${player.priority}" 
                         onclick="toggleSell(${player.id})">
                        <div class="player-top">
                            <div class="player-info">
                                <h4>${isSelected ? '‚úì ' : ''}${player.name}</h4>
                                <span class="player-meta">${player.team} ‚Ä¢ ${player.positionName} ‚Ä¢ ¬£${player.price.toFixed(1)}m</span>
                            </div>
                            <div class="player-rating">
                                <div class="rating-value ${player.priority}">${player.sellRating}</div>
                                <span class="rating-label ${player.priority}">${player.action}</span>
                            </div>
                        </div>
                        <div class="player-issues">
                            ${player.issues.map(i => `<span class="issue-tag ${i.type}">${i.text}</span>`).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateBudgetDisplay();
        }
        
        function toggleSell(playerId) {
            if (playersToSellIds.has(playerId)) {
                playersToSellIds.delete(playerId);
            } else {
                playersToSellIds.add(playerId);
            }
            
            // Update details array
            playersToSellDetails = analyzedTeam.filter(p => playersToSellIds.has(p.id));
            
            renderSellSelection();
            
            // Enable/disable next button
            document.getElementById('toFixturesBtn').disabled = playersToSellIds.size === 0;
        }
        
        function updateBudgetDisplay() {
            const sellingValue = playersToSellDetails.reduce((sum, p) => sum + p.price, 0);
            const totalBudget = itb + sellingValue;
            
            document.getElementById('itbValue').textContent = `¬£${itb.toFixed(1)}m`;
            document.getElementById('sellingValue').textContent = `¬£${sellingValue.toFixed(1)}m`;
            document.getElementById('totalBudget').textContent = `¬£${totalBudget.toFixed(1)}m`;
            document.getElementById('transferCount').textContent = playersToSellIds.size;
            
            // Also update step 4 budget
            const spendingValue = playersToBuy.reduce((sum, p) => sum + p.price, 0);
            document.getElementById('availableBudget').textContent = `¬£${totalBudget.toFixed(1)}m`;
            document.getElementById('spendingValue').textContent = `¬£${spendingValue.toFixed(1)}m`;
            document.getElementById('remainingBudget').textContent = `¬£${(totalBudget - spendingValue).toFixed(1)}m`;
            document.getElementById('inCount').textContent = playersToBuyIds.size;
        }
        
        // =====================================================
        // FIXTURE ANALYSIS (Step 3)
        // =====================================================
        function generateTeamAnalysis() {
            teamAnalysisData = Object.values(teams).map(team => {
                const fixtures = teamFixtures[team.id] || [];
                const avgFDR = fixtures.length > 0
                    ? fixtures.slice(0, 5).reduce((sum, f) => sum + f.difficulty, 0) / Math.min(5, fixtures.length)
                    : 3;
                
                // Calculate attack/defense ratings
                const attackRating = Math.round((team.strength_attack_home + team.strength_attack_away) / 2 / 13);
                const defenseRating = Math.round((team.strength_defence_home + team.strength_defence_away) / 2 / 13);
                
                return {
                    ...team,
                    fixtures: fixtures,
                    avgFDR: avgFDR,
                    attackRating: attackRating,
                    defenseRating: defenseRating
                };
            });
            
            // Sort by average FDR (easiest first)
            teamAnalysisData.sort((a, b) => a.avgFDR - b.avgFDR);
        }
        
        function renderFixtureAnalysis() {
            const container = document.getElementById('fixtureAnalysis');
            
            // Get positions being sold to suggest relevant teams
            const positionsSold = new Set(playersToSellDetails.map(p => p.position));
            
            let html = '';
            teamAnalysisData.slice(0, 12).forEach(team => {
                const fdrColor = team.avgFDR <= 2.5 ? 'var(--accent-green)' 
                    : team.avgFDR <= 3.0 ? 'var(--accent-yellow)' 
                    : 'var(--accent-red)';
                
                const fixturesHtml = team.fixtures.slice(0, 5).map(f => `
                    <span class="fixture-badge fdr-${f.difficulty}">${f.opponentName}(${f.isHome ? 'H' : 'A'})</span>
                `).join('');
                
                html += `
                    <div class="team-card" onclick="selectTeamFilter(${team.id})">
                        <div class="team-name">${team.avgFDR <= 2.5 ? 'üü¢' : team.avgFDR <= 3.0 ? 'üü°' : 'üî¥'} ${team.name}</div>
                        <div class="team-stats">
                            <div class="team-stat">
                                <div class="team-stat-value" style="color: ${fdrColor};">${team.avgFDR.toFixed(1)}</div>
                                <div class="team-stat-label">Avg FDR</div>
                            </div>
                            <div class="team-stat">
                                <div class="team-stat-value">${team.attackRating}%</div>
                                <div class="team-stat-label">Attack</div>
                            </div>
                        </div>
                        <div class="team-fixtures">${fixturesHtml}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function selectTeamFilter(teamId) {
            document.getElementById('teamFilter').value = teamId;
            goToStep(4);
        }
        
        // =====================================================
        // REPLACEMENT OPTIONS (Step 4)
        // =====================================================
        function filterReplacements() {
            const positionFilter = document.getElementById('positionFilter').value;
            const priceFilter = parseFloat(document.getElementById('priceFilter').value);
            const sortFilter = document.getElementById('sortFilter').value;
            const teamFilter = document.getElementById('teamFilter').value;
            
            // Calculate available budget
            const sellingValue = playersToSellDetails.reduce((sum, p) => sum + p.price, 0);
            const totalBudget = itb + sellingValue;
            const spendingValue = playersToBuy.reduce((sum, p) => sum + p.price, 0);
            const availableBudget = totalBudget - spendingValue;
            
            // Get positions being sold
            const positionsSold = playersToSellDetails.map(p => p.position);
            
            // Filter players
            let filtered = allPlayers.filter(p => {
                // Exclude players already in team (not being sold)
                const inTeamNotSelling = myTeam.some(tp => tp.id === p.id) && !playersToSellIds.has(p.id);
                if (inTeamNotSelling) return false;
                
                // Exclude already selected to buy
                if (playersToBuyIds.has(p.id)) return false;
                
                // Position filter
                if (positionFilter !== 'all' && p.position !== parseInt(positionFilter)) return false;
                
                // Price filter
                if (p.price > priceFilter) return false;
                
                // Team filter
                if (teamFilter !== 'all' && p.teamId !== parseInt(teamFilter)) return false;
                
                // Must be available
                if (p.status === 'i' || p.status === 's') return false;
                
                // Minimum minutes
                if (p.minutes < 200) return false;
                
                return true;
            });
            
            // Calculate recommendation score for each player
            filtered.forEach(p => {
                const xGIPer90 = p.minutes > 0 ? (p.expectedGI / p.minutes) * 90 : 0;
                const valueScore = p.price > 0 ? p.totalPoints / p.price : 0;
                
                // Weighted score
                p.recScore = (p.form * 2) + (xGIPer90 * 10) + (valueScore * 0.5) + ((5 - p.avgFDR) * 3);
                
                // Bonus for easy fixtures
                if (p.avgFDR <= 2.5) p.recScore += 5;
            });
            
            // Sort
            switch (sortFilter) {
                case 'form':
                    filtered.sort((a, b) => b.form - a.form);
                    break;
                case 'xgi':
                    filtered.sort((a, b) => {
                        const aXGI = a.minutes > 0 ? (a.expectedGI / a.minutes) * 90 : 0;
                        const bXGI = b.minutes > 0 ? (b.expectedGI / b.minutes) * 90 : 0;
                        return bXGI - aXGI;
                    });
                    break;
                case 'price':
                    filtered.sort((a, b) => a.price - b.price);
                    break;
                case 'fixtures':
                    filtered.sort((a, b) => a.avgFDR - b.avgFDR);
                    break;
                default: // score
                    filtered.sort((a, b) => b.recScore - a.recScore);
            }
            
            renderReplacements(filtered.slice(0, 50));
        }
        
        function renderReplacements(players) {
            const container = document.getElementById('replacementOptions');
            
            if (players.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">üîç</div>
                        <h3>No Players Found</h3>
                        <p>Try adjusting your filters.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            players.forEach(player => {
                const xGIPer90 = player.minutes > 0 ? (player.expectedGI / player.minutes) * 90 : 0;
                const valueScore = player.price > 0 ? player.totalPoints / player.price : 0;
                const isSelected = playersToBuyIds.has(player.id);
                
                const fixturesHtml = player.fixtures?.slice(0, 3).map(f => `
                    <span class="fixture-badge fdr-${f.difficulty}">${f.opponentName}(${f.isHome ? 'H' : 'A'})</span>
                `).join('') || '';
                
                html += `
                    <div class="replacement-card ${isSelected ? 'selected' : ''}" onclick="toggleBuy(${player.id})">
                        <div class="replacement-header">
                            <div>
                                <div class="replacement-name">${isSelected ? '‚úì ' : ''}${player.name}</div>
                                <div class="replacement-meta">${player.teamName} ‚Ä¢ ${player.positionName}</div>
                            </div>
                            <div class="replacement-price">¬£${player.price.toFixed(1)}m</div>
                        </div>
                        <div class="replacement-stats">
                            <div class="rep-stat">
                                <div class="rep-stat-value">${player.form.toFixed(1)}</div>
                                <div class="rep-stat-label">Form</div>
                            </div>
                            <div class="rep-stat">
                                <div class="rep-stat-value">${xGIPer90.toFixed(2)}</div>
                                <div class="rep-stat-label">xGI/90</div>
                            </div>
                            <div class="rep-stat">
                                <div class="rep-stat-value">${valueScore.toFixed(1)}</div>
                                <div class="rep-stat-label">Pts/¬£m</div>
                            </div>
                            <div class="rep-stat">
                                <div class="rep-stat-value" style="color: ${player.avgFDR <= 2.5 ? 'var(--accent-green)' : player.avgFDR <= 3.0 ? 'var(--accent-yellow)' : 'var(--accent-red)'};">${player.avgFDR.toFixed(1)}</div>
                                <div class="rep-stat-label">FDR</div>
                            </div>
                        </div>
                        <div class="team-fixtures">${fixturesHtml}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function toggleBuy(playerId) {
            const player = allPlayers.find(p => p.id === playerId);
            
            if (playersToBuyIds.has(playerId)) {
                playersToBuyIds.delete(playerId);
                playersToBuy = playersToBuy.filter(p => p.id !== playerId);
            } else {
                // Check budget
                const sellingValue = playersToSellDetails.reduce((sum, p) => sum + p.price, 0);
                const totalBudget = itb + sellingValue;
                const currentSpending = playersToBuy.reduce((sum, p) => sum + p.price, 0);
                
                if (currentSpending + player.price > totalBudget) {
                    alert('Not enough budget for this player!');
                    return;
                }
                
                // Check max transfers
                if (playersToBuyIds.size >= playersToSellIds.size) {
                    alert(`You can only bring in ${playersToSellIds.size} player(s) to match your outgoing transfers.`);
                    return;
                }
                
                playersToBuyIds.add(playerId);
                playersToBuy.push(player);
            }
            
            updateBudgetDisplay();
            filterReplacements();
            
            // Enable review button if transfers match
            document.getElementById('toReviewBtn').disabled = playersToBuyIds.size !== playersToSellIds.size;
        }
        
        // =====================================================
        // REVIEW (Step 5)
        // =====================================================
        function renderReview() {
            const container = document.getElementById('transferSummary');
            
            const sellingValue = playersToSellDetails.reduce((sum, p) => sum + p.price, 0);
            const buyingValue = playersToBuy.reduce((sum, p) => sum + p.price, 0);
            const netSpend = buyingValue - sellingValue;
            
            // Calculate improvements
            const avgSellFDR = playersToSellDetails.reduce((sum, p) => sum + p.avgFDR, 0) / playersToSellDetails.length;
            const avgBuyFDR = playersToBuy.reduce((sum, p) => sum + p.avgFDR, 0) / playersToBuy.length;
            const fdrImprovement = avgSellFDR - avgBuyFDR;
            
            const avgSellForm = playersToSellDetails.reduce((sum, p) => sum + p.form, 0) / playersToSellDetails.length;
            const avgBuyForm = playersToBuy.reduce((sum, p) => sum + p.form, 0) / playersToBuy.length;
            const formImprovement = avgBuyForm - avgSellForm;
            
            let html = `
                <div class="summary-box">
                    <div class="summary-title">üìã Transfer Summary</div>
            `;
            
            // Create transfer rows
            for (let i = 0; i < playersToSellDetails.length; i++) {
                const out = playersToSellDetails[i];
                const inPlayer = playersToBuy[i];
                
                html += `
                    <div class="transfer-row">
                        <div class="transfer-out">
                            <div class="transfer-player-name">${out.name}</div>
                            <div class="transfer-player-team">${out.team} ‚Ä¢ ${out.positionName}</div>
                            <div class="transfer-player-price out">-¬£${out.price.toFixed(1)}m</div>
                        </div>
                        <div class="transfer-arrow">‚Üí</div>
                        <div class="transfer-in">
                            <div class="transfer-player-name">${inPlayer.name}</div>
                            <div class="transfer-player-team">${inPlayer.team} ‚Ä¢ ${inPlayer.positionName}</div>
                            <div class="transfer-player-price in">+¬£${inPlayer.price.toFixed(1)}m</div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            
            // Stats
            html += `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" style="color: ${netSpend <= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                            ${netSpend <= 0 ? '+' : '-'}¬£${Math.abs(netSpend).toFixed(1)}m
                        </div>
                        <div class="stat-label">${netSpend <= 0 ? 'Money Saved' : 'Net Spend'}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: ${fdrImprovement > 0 ? 'var(--accent-green)' : 'var(--accent-yellow)'};">
                            ${fdrImprovement > 0 ? '+' : ''}${fdrImprovement.toFixed(1)}
                        </div>
                        <div class="stat-label">FDR Improvement</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: ${formImprovement > 0 ? 'var(--accent-green)' : 'var(--accent-yellow)'};">
                            ${formImprovement > 0 ? '+' : ''}${formImprovement.toFixed(1)}
                        </div>
                        <div class="stat-label">Form Upgrade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${playersToSellDetails.length > freeTransfers ? (playersToSellDetails.length - freeTransfers) * -4 : 0}</div>
                        <div class="stat-label">Point Hit</div>
                    </div>
                </div>
            `;
            
            // Success message
            if (fdrImprovement > 0 && formImprovement >= 0 && netSpend <= 0) {
                html += `
                    <div class="success-box">
                        <h4>‚úÖ Smart Transfer Detected</h4>
                        <p>You're improving fixtures, upgrading form, AND saving money. Execute with confidence!</p>
                    </div>
                `;
            } else if (fdrImprovement > 0 || formImprovement > 0) {
                html += `
                    <div class="success-box" style="border-color: var(--accent-yellow); background: rgba(255, 165, 2, 0.1);">
                        <h4 style="color: var(--accent-yellow);">‚ö° Good Transfer</h4>
                        <p>This transfer improves your squad. Consider the trade-offs.</p>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function executeTransfers() {
            // Save transfer plan to localStorage
            const plan = {
                date: new Date().toISOString(),
                out: playersToSellDetails.map(p => ({ id: p.id, name: p.name, team: p.team, price: p.price })),
                in: playersToBuy.map(p => ({ id: p.id, name: p.name, team: p.team, price: p.price }))
            };
            
            localStorage.setItem('fpl_transfer_plan', JSON.stringify(plan));
            
            // Open FPL transfers page
            alert('Transfer plan saved! Opening FPL transfers page...');
            window.open('https://fantasy.premierleague.com/transfers', '_blank');
        }
        
        // =====================================================
        // NAVIGATION
        // =====================================================
        function goToStep(step) {
            // Validation
            if (step === 2 && myTeam.length !== 15) {
                alert('Please build your team first!');
                return;
            }
            
            if (step === 3 && playersToSellIds.size === 0) {
                alert('Please select at least one player to sell.');
                return;
            }
            
            if (step === 5 && playersToBuyIds.size !== playersToSellIds.size) {
                alert('Please select replacements for all outgoing players.');
                return;
            }
            
            // Update panels
            document.querySelectorAll('.step-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(`panel-${step}`).classList.add('active');
            
            // Update progress
            document.querySelectorAll('.progress-step').forEach((el, index) => {
                el.classList.remove('active', 'completed', 'disabled');
                if (index + 1 < step) {
                    el.classList.add('completed');
                } else if (index + 1 === step) {
                    el.classList.add('active');
                } else if (index + 1 > step + 1) {
                    el.classList.add('disabled');
                }
            });
            
            currentStep = step;
            
            // Step-specific rendering
            if (step === 2) {
                renderSellSelection();
            } else if (step === 3) {
                renderFixtureAnalysis();
            } else if (step === 4) {
                // Auto-set position filter based on what's being sold
                if (playersToSellDetails.length === 1) {
                    document.getElementById('positionFilter').value = playersToSellDetails[0].position;
                }
                filterReplacements();
            } else if (step === 5) {
                renderReview();
            }
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function updateStatus(message, type = 'loading') {
            const bar = document.getElementById('statusBar');
            const text = document.getElementById('statusText');
            
            bar.className = `status-bar ${type}`;
            
            if (type === 'loading') {
                bar.innerHTML = `<div class="spinner"></div><span>${message}</span>`;
            } else {
                bar.innerHTML = `<span>${type === 'success' ? '‚úì' : '‚ö†'} ${message}</span>`;
            }
        }
        
        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>
